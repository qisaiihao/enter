# 开发注意事项

## 开发原则

### 优先使用原生方案
**重要原则：** 有微信原生支持的方案，就用现成的，不要自己写

**示例：**
- 键盘遮挡问题：使用 `cursor-spacing` 属性，而不是手动计算高度和滚动
- 图片压缩：使用 `wx.compressImage` API，而不是自己实现压缩算法
- 页面滚动：使用 `adjust-position` 属性，而不是手动控制页面位置

**原因：**
- 原生方案更稳定可靠，经过微信团队充分测试
- 避免时序问题和兼容性问题
- 代码更简洁，维护成本更低
- 在不同设备和微信版本上表现一致

## 云函数开发注意事项

### 1. 环境对象使用错误
**错误示例：**
```javascript
// ❌ 错误：在云函数中使用 wx 对象
wx.cloud.getTempFileURL({ fileList: [fileID] })
```

**正确做法：**
```javascript
// ✅ 正确：在云函数中使用 cloud 对象
cloud.getTempFileURL({ fileList: [fileID] })
```

**注意事项：**
- `wx` 对象只在客户端环境中存在
- 云函数运行在 Node.js 环境中，应该使用 `cloud` 对象
- 常见的错误：`wx.cloud.getTempFileURL`、`wx.cloud.database()` 等

### 2. 数据库查询字段映射
**错误示例：**
```javascript
// ❌ 错误：假设所有数据都有相同的字段结构
post.imageUrls = post.imageUrls ? [post.imageUrls] : [];
```

**正确做法：**
```javascript
// ✅ 正确：处理不同的字段结构
let imageUrls = [];
if (post.imageUrls && Array.isArray(post.imageUrls)) {
  imageUrls = post.imageUrls;
} else if (post.imageUrl) {
  imageUrls = [post.imageUrl];
}
```

**注意事项：**
- 不同时期的数据可能有不同的字段结构
- 需要兼容 `imageUrl`（单数）和 `imageUrls`（复数）
- 总是检查字段是否存在和类型是否正确

### 3. 数据聚合逻辑
**错误示例：**
```javascript
// ❌ 错误：直接返回简单的查询结果
const result = await db.collection('favorites').where({...}).get();
return { success: true, favorites: result.data };
```

**正确做法：**
```javascript
// ✅ 正确：进行完整的数据聚合
const favorites = result.data;
const postIds = favorites.map(fav => fav.postId);
const posts = await db.collection('posts').where({
  _id: db.command.in(postIds)
}).get();
// 然后进行数据合并和字段映射
```

**注意事项：**
- 收藏记录只包含 `postId`，需要去 `posts` 集合获取完整信息
- 需要获取用户信息、评论数量等关联数据
- 确保返回的数据结构完整且一致

## 前端开发注意事项

### 1. 数据字段映射
**错误示例：**
```javascript
// ❌ 错误：假设云函数返回的字段名与前端期望一致
favorite.imageUrls = favorite.postImageUrls;
```

**正确做法：**
```javascript
// ✅ 正确：进行明确的字段映射
if (favorite.postImageUrls && Array.isArray(favorite.postImageUrls)) {
  favorite.imageUrls = favorite.postImageUrls;
} else if (favorite.postImageUrl) {
  favorite.imageUrls = [favorite.postImageUrl];
} else {
  favorite.imageUrls = [];
}
```

**注意事项：**
- 云函数返回的字段名可能与前端期望不一致
- 需要在前端进行字段映射和数据处理
- 确保所有必要的字段都有默认值

### 2. WXML 字段引用
**错误示例：**
```xml
<!-- ❌ 错误：WXML 中使用错误的字段名 -->
<view wx:if="{{item.postImageUrls && item.postImageUrls.length > 0}}">
  <image src="{{item.postImageUrls[0]}}" />
</view>
```

**正确做法：**
```xml
<!-- ✅ 正确：使用前端映射后的字段名 -->
<view wx:if="{{item.imageUrls && item.imageUrls.length > 0}}">
  <image src="{{item.imageUrls[0]}}" />
</view>
```

**注意事项：**
- WXML 中使用的字段名必须与前端数据一致
- 修改数据映射后，WXML 也要相应更新
- 确保条件判断和循环使用的字段名正确

### 3. 调试日志添加
**错误示例：**
```javascript
// ❌ 错误：没有调试信息，难以排查问题
wx.cloud.callFunction({
  name: 'getMyProfileData',
  data: { action: 'getFavoritesByFolder' },
  success: res => {
    // 直接处理结果，没有日志
  }
});
```

**正确做法：**
```javascript
// ✅ 正确：添加详细的调试日志
wx.cloud.callFunction({
  name: 'getMyProfileData',
  data: { action: 'getFavoritesByFolder' },
  success: res => {
    console.log('云函数调用成功，返回结果:', res);
    console.log('res.result:', res.result);
    // 处理结果
  },
  fail: err => {
    console.error('云函数调用失败:', err);
  }
});
```

**注意事项：**
- 在关键位置添加调试日志
- 记录云函数调用结果和错误信息
- 便于快速定位问题所在

## 数据库设计注意事项

### 1. 数据一致性
**注意事项：**
- 确保相关集合之间的数据一致性
- 收藏记录应该包含必要的帖子信息，或者能够通过关联查询获取
- 考虑数据冗余 vs 查询性能的平衡

### 2. 字段命名规范
**注意事项：**
- 保持字段命名的一致性
- 区分单数和复数形式（如 `imageUrl` vs `imageUrls`）
- 使用清晰的前缀（如 `postTitle`、`postContent`）

## 部署注意事项

### 1. 云函数部署
**注意事项：**
- 修改云函数后必须重新部署
- 检查云函数的环境变量和权限设置
- 确保云函数能访问所需的数据库集合

### 2. 缓存清理
**注意事项：**
- 修改代码后清理小程序缓存
- 重新编译和预览
- 检查是否使用了最新的代码版本

## 常见错误总结

1. **环境对象混用**：在云函数中使用 `wx` 对象
2. **字段映射错误**：假设数据字段结构一致
3. **数据聚合不完整**：直接返回简单查询结果
4. **WXML 字段不匹配**：前端数据与模板字段不一致
5. **缺少调试信息**：没有足够的日志来排查问题
6. **忘记重新部署**：修改云函数后没有重新部署

## 最佳实践

1. **始终添加调试日志**：在关键位置记录数据状态
2. **处理数据兼容性**：考虑不同时期数据的字段差异
3. **完整的错误处理**：捕获并记录所有可能的错误
4. **数据验证**：确保返回的数据结构完整
5. **渐进式开发**：先实现基本功能，再优化细节
6. **及时测试**：每次修改后立即测试功能是否正常
