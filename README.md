# 回车键小程序

一个基于微信云开发的社交内容分享平台，支持诗歌创作、图片分享、用户互动等功能。

## 最近更新

### 2024年双图层背景切换优化
- **修复首次显示卡顿问题**：解决从开屏进入poem/mountain页面时双图层系统未初始化导致的卡顿问题
- **首次显示逻辑优化**：首次显示时直接设置第一个图层，避免双图层切换动画的延迟
- **预加载缓存同步**：优化全局预加载缓存与本地缓存的同步机制，确保预加载图片立即可用
- **立即预加载第二张**：首次显示完成后立即预加载第二张图片，确保第一次切换时不会卡顿
- **文字优先切换策略**：文字卡片立即切换，背景图延迟100ms切换，确保用户能立即看到内容变化
- **轻量级切换机制**：使用智能延迟（预加载图片50ms，网络图片150ms），平衡性能和体验
- **消除白色闪屏**：通过分步切换和预加载路径优化，大幅减少切换时的白色闪屏问题
- **平滑切换保持**：后续的图片切换仍然使用双图层平滑过渡，保持流畅的视觉体验
- **调试日志完善**：添加详细的预加载、切换和加载完成日志，便于排查和监控图片状态
- **完整方案文档**：创建《双图层背景切换完整方案.md》文档，记录事件监听方案的完整实现

### 2024年主页消息图标功能
- **添加信封图标按钮**：在主页右上角添加信封图标按钮，点击可跳转到消息页面
- **未读消息红点提示**：当有未读消息时，在信封图标右上角显示红色圆点提示
- **实时消息数量检查**：页面显示时自动检查未读消息数量，确保红点状态实时更新
- **磨砂玻璃效果**：消息图标采用磨砂玻璃背景，与整体UI风格保持一致
- **脉冲动画效果**：未读消息红点添加脉冲动画，增强视觉吸引力
- **点击反馈优化**：添加点击缩放效果，提供良好的交互反馈

### 2024年开屏打字机动画效果
- **实现打字机动画**：为开屏页面添加"poementer"文字的打字机动画效果，逐字显示文字
- **人性化打字节奏**：每个字母出现时间有差异，模拟真实人打字的节奏，在"poem"后停顿再继续打"enter"
- **状态管理优化**：通过currentPhase状态控制不同阶段的显示（typing → imageDisplay → done）
- **闪烁光标效果**：添加闪烁光标动画，模拟真实打字机效果
- **进入按钮交互**：打字动画完成后显示"进入"按钮，用户点击后切换到开屏图显示
- **并行预加载机制**：打字机动画与图片预加载并行执行，提升加载效率
- **智能跳转控制**：修复预加载完成后自动跳转的问题，现在必须等待用户点击"进入"按钮才能跳转
- **预加载状态显示**：按钮根据预加载状态显示"进入"或"加载中..."，提供清晰的用户反馈
- **简化用户体验**：暂时注释掉开屏图显示功能，用户点击"进入"按钮后直接跳转到主页，提升启动速度
- **优化视觉风格**：将打字机动画改为白底黑字风格，提供更清爽的视觉效果
- **回车键风格按钮**：将"进入"按钮改为"enter"文字，并设计成类似回车键的样式，包含回车符号图标
- **换行光标交互**：点击enter按钮后，光标换行到下一行居中闪烁两下，然后进入首页，模拟真实的回车键换行效果
- **光标切换优化**：点击enter后自动隐藏原光标，只显示换行后的新光标，避免重复显示
- **平滑动画效果**：enter按钮出现时使用平滑的上移动画，避免闪现，提升视觉体验
- **文字平滑上移**：当enter按钮出现时，文字平滑上移80rpx，避免突然的位置变化
- **按钮绝对定位**：使用绝对定位让enter按钮不占用布局空间，避免文字被"挤"上去的瞬移问题
- **光标间距优化**：调整换行后光标与文字的距离为40rpx，提供更美观的视觉间距
- **分层布局设计**：将文字和按钮放在不同的图层，使用绝对定位让它们完全独立，互不影响
- **光标透明隐藏**：使用透明度变化隐藏原光标，而不是移除元素，确保布局完全稳定
- **平滑过渡动画**：为进入按钮和开屏图显示添加淡入动画，提升用户体验
- **触觉反馈优化**：为进入按钮添加震动反馈，增强交互体验
- **保持原有功能**：完全保留原有的预加载逻辑和页面跳转功能，确保功能完整性

### 2024年自定义tabBar磨砂效果
- **创建自定义tabBar组件**：实现圆角矩形磨砂效果的tabBar，支持半透明背景和毛玻璃效果
- **启用自定义tabBar**：在app.json中设置"custom": true，启用自定义tabBar功能
- **磨砂视觉效果**：使用backdrop-filter: blur(20rpx)实现毛玻璃效果，rgba(255, 255, 255, 0.8)实现半透明背景
- **圆角设计**：50rpx圆角半径，居中悬浮设计，底部留白20rpx
- **阴影效果**：添加box-shadow和边框效果，提升视觉层次感
- **页面集成**：在所有tab页面（广场、路、山、湖）中集成自定义tabBar组件
- **修复图片路径问题**：将图片路径从相对路径改为绝对路径（/images/），解决图片加载失败问题
- **完善点击逻辑**：添加完整的tabBar点击事件处理，支持页面切换和状态更新
- **状态同步机制**：在每个页面的onShow方法中添加tabBar状态更新逻辑，确保选中状态正确显示
- **修复图标绑定问题**：改进路径匹配逻辑，支持多种路径格式，修复点击图标时选中状态错乱的问题
- **添加调试信息**：在tabBar中添加调试文本显示，帮助排查选中状态问题
- **彻底修复状态同步问题**：采用官方推荐的最佳实践，简化tabBar组件逻辑，完全依赖页面的onShow生命周期来设置选中状态，确保状态同步的绝对可靠性
- **修复onShow方法逻辑问题**：解决poem.js和mountain.js中onShow方法的isFirstLoad标志位导致的提前return问题，确保tabBar状态更新始终执行
- **修复语法错误**：修复poem.js和mountain.js中else语句块缺少闭合大括号的语法错误，确保代码正常编译
- **添加详细调试日志**：为所有页面的onShow方法和tabBar组件添加详细的console.log，帮助排查tabBar状态同步问题
- **修复自定义tabBar位置问题**：将custom-tabbar从components文件夹移动到根目录custom-tab-bar，解决getTabBar()找不到组件的根本问题，确保小程序框架能正确识别自定义tabBar
- **统一页面加载体验架构**：按照提示.md建议实施UI渲染与数据请求分离的架构，为所有tab页面添加统一的骨架屏加载体验，poem页面支持预加载数据秒开，其他页面显示骨架屏后异步加载数据
- **完成所有tab页面架构统一**：为广场页（index.js）和个人主页（profile.js）应用相同的架构模式，实现所有四个tab页面的加载体验完全统一，确保用户在任何页面切换时都有一致的体验
- **修复WXML标签闭合错误**：修复index.wxml、profile.wxml、mountain.wxml中多余的闭合标签和缺失的闭合标签导致的编译错误，确保所有WXML文件语法正确
- **修复profile页面WXML编译错误**：修复profile.wxml中sidebar标签结构错误导致的"end tag missing"编译错误，确保页面正常渲染
- **修复mountain页面预加载问题**：修复mountain.js缺少预加载数据检查逻辑的问题，在开屏页面添加mountain页面数据预加载，解决"invalid url"预加载失败错误
- **修复滑动切换时骨架屏问题**：为poem.js和mountain.js添加专门的loadMorePosts函数，避免在滑动切换帖子时显示骨架屏，确保骨架屏只在首次进入页面时使用

### 2024年收藏页面优化
- **修复文字换行问题**：仿照首页广场页面，为收藏页面和profile页面的收藏部分添加`white-space: pre-wrap;`样式，确保文字正确换行显示
- **修复匿名用户显示问题**：修复云函数中的语法错误，确保收藏时正确保存作者信息，获取收藏数据时能正确显示作者姓名和头像
- **完善收藏体验**：统一收藏页面的显示效果，与首页广场页面保持一致的用户体验

### 2024年字数限制优化
- **放宽帖子字数限制**：将发布帖子的字数限制从默认限制放宽到1500字，满足用户发布更长内容的需求
- **添加字数统计显示**：在发布页面添加实时字数统计，显示"当前字数/1500"格式
- **优化输入体验**：为标题输入框设置50字限制，为评论输入框设置200字限制，提供更好的输入体验
- **完善字数提示**：通过maxlength属性确保用户了解字数限制，避免发布时才发现超限

### 2024年UI图标优化
- **重新设计tab图标系统**：将tab图标改为market（广场）、road（路）、mountain（山）、pools（湖），每个都有点击与未点击两种状态
- **完善tab结构**：保持4个tab的完整结构，包括广场、路、山、湖
- **统一图标风格**：所有tab图标使用统一的命名规范和视觉风格

### 2024年开屏预加载优化
- **修复图片路径问题**：将所有本地图片的相对路径改为绝对路径，解决"file not found"错误
- **统一云函数数据字段**：修复splash.js和poem.js中数据字段不一致问题，统一使用posts字段
- **优化预加载机制**：使用wx.downloadFile替代wx.getImageInfo，实现更可靠的图片预加载
- **Promise.all优化时机**：使用Promise.all等待所有预加载任务完成，避免固定setTimeout的弊端
- **全局预加载缓存**：创建app.globalData.preloadedImages全局缓存，实现开屏和poem页面无缝衔接
- **智能跳转机制**：预加载完成后立即跳转，实现"最快加载，无缝跳转"的理想效果
- **修复Promise链条断裂**：解决preloadFirstPostImages异步任务未等待完成就跳转的关键bug
- **移除svg预加载**：小程序不支持svg格式，移除相关预加载避免错误
- **完善异步流程**：使用async/await确保图片下载完成后再跳转，彻底解决闪烁问题
- **修复onLoad与onShow冲突**：使用isFirstLoad标志位避免预加载数据被onShow强制清空
- **解决骨架屏闪烁**：首次加载时onShow跳过刷新逻辑，保持预加载数据，实现真正秒开

### 2024年mountain页面双图层背景优化
- **实现双图层背景切换**：采用两个image标签实现真正的交叉淡入淡出效果，替代无效的background-image过渡
- **独立内容数据管理**：使用currentPost对象替代postList[currentPostIndex]，避免整个卡片重新渲染
- **极致流畅切换体验**：通过opacity透明度控制实现平滑过渡，视觉上更加高级自然
- **性能优化提升**：减少小程序渲染开销，在低端机型上表现更佳
- **代码结构优化**：将updatePostDisplay和switchBackgroundImage逻辑分离，代码更清晰易维护
- **预加载机制保留**：继续使用wx.downloadFile预加载图片到本地，确保切换瞬间完成
- **修复onLoad与onShow冲突**：使用isFirstLoad标志位避免预加载数据被onShow强制清空
- **全局预加载缓存支持**：支持使用开屏预加载的图片缓存，实现无缝衔接

### 2024年poem页面双图层背景优化
- **实现双图层背景切换**：采用两个image标签实现真正的交叉淡入淡出效果，替代无效的background-image过渡
- **独立内容数据管理**：使用currentPost对象替代postList[currentPostIndex]，避免整个卡片重新渲染
- **极致流畅切换体验**：通过opacity透明度控制实现平滑过渡，视觉上更加高级自然
- **性能优化提升**：减少小程序渲染开销，在低端机型上表现更佳
- **代码结构优化**：将updatePostDisplay和switchBackgroundImage逻辑分离，代码更清晰易维护
- **预加载机制保留**：继续使用wx.downloadFile预加载图片到本地，确保切换瞬间完成

### 2024年开屏页面优化
- **修复开屏页面显示问题**：解决小程序启动时直接跳转到poem页面而不显示开屏页面的问题
- **优化页面跳转逻辑**：将自动登录逻辑从app.js移到开屏页面，确保开屏页面正常显示
- **修复图片路径问题**：更正开屏图片的引用路径，确保图片正常加载
- **智能跳转机制**：开屏页面根据用户登录状态智能跳转到相应页面（已登录跳转poem页面，未登录跳转登录页面）
- **预加载优化**：在开屏期间预加载poem页面数据，实现秒开体验
- **平滑切换动画**：添加开屏到poem页面的淡出缩放动画，提升用户体验
- **全屏显示修复**：修复开屏页面左侧缝隙问题，实现完美全屏显示

### 2024年背景切换优化
- **简化背景切换方案**：采用业内标准的双层背景图叠加方案，替代复杂的双缓冲机制
- **优化切换逻辑**：使用简单的opacity过渡，先设置下一张背景图，再切换当前背景图
- **提升过渡效果**：将过渡时间调整为0.5s，使用ease-in-out缓动函数，确保切换更加平滑自然

### 2024年性能优化更新
- **代码清理优化**：移除大量测试代码和调试信息，删除临时文件，提升运行效率
- **背景图显示优化**：poem和mountain页面统一使用压缩图作为背景，避免加载原图，减少流量消耗
- **图片压缩算法加强**：提升压缩率，质量降低到65%，尺寸限制到600px，使用webp格式，大幅减小文件体积
- **预加载机制优化**：精简预加载逻辑，只预加载必要图片，减少内存占用和网络请求
- **云函数性能提升**：清理云函数调试代码，减少不必要的日志输出，提升执行速度

### 2024年首页列表加载优化
- **解决并发请求问题**：禁用onReachBottom，统一使用onPageScroll进行预加载，避免重复请求导致的卡顿
- **优化加载状态管理**：添加isLoadingMore状态，提供明确的"正在加载..."和"没有更多了"UI反馈
- **图片占位高度优化**：为图片添加4:3宽高比占位，防止图片加载完成后的布局抖动和闪烁
- **容器ID优化**：为帖子列表容器添加#post-list-container ID，提高滚动检测的准确性
- **防抖机制优化**：简化onPageScroll的防抖逻辑，减少不必要的DOM查询，提升性能
- **加载锁机制**：使用isLoading状态锁严格防止并发请求，确保数据加载的稳定性
- **修复滑动时骨架屏问题**：区分首次加载和滑动加载，只有首次加载时显示骨架屏，滑动加载更多时只显示底部加载提示
- **修复wx:key重复警告**：强化并发控制，使用严格的"上锁->请求->解锁"流程，彻底杜绝因并发请求导致的数据重复问题
- **修复API废弃警告**：将wx.getSystemInfoSync替换为wx.getWindowInfo，提升代码规范性和性能
- **修复骨架屏逻辑错误**：修正并发控制修复时引入的逻辑错误，确保只有首次加载时显示骨架屏，滑动加载更多时只显示底部提示
- **彻底修复并发请求漏洞**：同时检查isLoading和isLoadingMore状态，确保任何时候只有一个请求在进行，彻底杜绝数据重复问题
- **激活图片占位方案**：在WXML中使用JS生成的imageStyle，通过padding-bottom技巧实现4:3宽高比占位，彻底解决图片加载导致的布局抖动和闪烁
- **优化图片容器布局**：采用"父相子绝"布局方式，图片容器通过padding-bottom撑开占位空间，内部图片绝对定位填充，确保布局稳定
- **增强tab栏磨砂效果**：降低自定义tab栏背景不透明度从0.8到0.6，增强毛玻璃视觉效果，让背景内容更加清晰可见

### 2024年功能更新
- **个人中心收藏显示**：在个人中心添加收藏标签，可查看所有收藏内容，按时间排序
- **收藏作者信息修复**：修复收藏列表显示"匿名用户"的问题，正确显示作者姓名和头像
- **用户个人主页功能**：点击头像可进入用户个人主页，查看TA的帖子和个性签名
- **独立用户主页页面**：创建专门的用户主页页面，提供更好的浏览体验
- **动态点赞图标系统**：实现根据点赞数动态显示不同图标的点赞按钮，3以下显示种子，4-7显示叶子，8-15显示花，15以上显示果实，已点赞状态显示对应的高亮版本

## 参考文档

- [云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)

