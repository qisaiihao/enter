# 回车键小程序

一个基于微信云开发的社交内容分享平台，支持诗歌创作、图片分享、用户互动等功能。

## 最近更新

### 2024年发布页面重新设计
- **简洁布局设计**：重新设计发布页面，采用更简洁的界面布局，图片预览移到顶部
- **顶部导航栏**：添加简洁的顶部导航栏，包含返回按钮、标题和发布按钮
- **图片预览优化**：图片在顶部以网格形式预览，支持多张图片上传和删除
- **内容输入区域**：标题和正文输入区域采用无边框设计，更加简洁美观
- **底部工具栏**：添加底部工具栏，包含图片、标签、引用、更多等功能按钮
- **发布状态管理**：实时检查发布条件，只有满足条件时发布按钮才可点击
- **交互体验优化**：点击图片图标可以上传，上传后在顶部预览，操作更加直观
- **响应式布局**：适配不同屏幕尺寸，确保在各种设备上都有良好的显示效果

### 2024年双击Tab刷新功能
- **实现双击Tab刷新**：双击当前选中的tab图标可以自动刷新页面内容
- **智能双击检测**：300毫秒内连续点击同一tab且为当前选中tab时触发刷新
- **页面特定刷新**：根据不同页面调用相应的刷新方法（广场、路、山、湖）
- **刷新方法优先级**：优先调用页面自定义刷新方法，其次调用下拉刷新，最后使用通用刷新
- **调试日志完善**：添加详细的双击检测和刷新执行日志，便于调试和监控
- **用户体验优化**：提供快速刷新页面的便捷方式，无需下拉刷新

### 2024年推荐算法优化
- **修复推荐算法问题**：解决推荐页面只显示热门帖子，没有按标签推荐的问题
- **增加按标签推荐功能**：当个性化推荐为空时，自动使用热门标签进行推荐
- **改进推荐逻辑**：个性化推荐 → 按标签推荐 → 热门推荐 → 最新推荐的层级推荐策略
- **热门标签分析**：自动分析所有帖子的标签，找出前10个热门标签进行推荐
- **标签匹配评分**：根据帖子包含的热门标签数量进行评分排序
- **推荐类型标识**：为每种推荐类型添加标识（个性化、按标签、热门、最新）
- **用户历史记录优化**：确保浏览记录和点赞记录功能正常工作
- **推荐结果统计**：前端显示各种推荐类型的数量统计，便于调试
- **新用户模拟数据**：为新用户自动创建模拟互动记录，确保推荐算法能正常工作
- **详细调试日志**：增加详细的调试日志，便于排查推荐算法问题
- **混合内容推荐**：推荐算法现在包含原创和非原创帖子，提供更丰富的内容推荐
- **发现页优化**：关闭发现页的加载更多功能，只使用推荐算法，避免无意义的加载更多
- **滚动监听优化**：修复onPageScroll方法，在发现页不会触发预加载，避免反复加载的情况

### 2024年详情页键盘弹起优化
- **实现键盘高度监听**：通过bindfocus事件获取实时键盘高度，自动适应不同设备的键盘高度差异
- **动态输入框定位**：输入框容器根据键盘高度动态调整bottom位置，确保始终位于键盘上方
- **禁用自动上推**：设置adjust-position="{{false}}"，由自己精确控制输入框位置，避免系统默认行为干扰
- **遮罩层交互**：添加半透明遮罩层，点击可收起输入框，提升用户体验
- **平滑动画效果**：输入框上移和下移都有流畅的过渡动画，视觉效果更佳
- **自动聚焦机制**：点击展开输入框时自动获取焦点，键盘立即弹起
- **智能收起逻辑**：失去焦点时延迟100ms收起，避免点击发送按钮时输入框提前消失
- **回复功能集成**：点击回复按钮时自动展开输入框并聚焦，无缝衔接回复流程
- **提交后自动收起**：评论提交成功后自动收起输入框，清理回复状态
- **全面屏适配**：支持iPhone X等设备的底部安全区域，确保输入框不被遮挡
- **状态管理优化**：通过isInputExpanded、keyboardHeight、isFocus等状态精确控制输入框行为

### 2024年详情页输入框布局优化
- **输入框大幅拓宽**：将发送按钮宽度从120rpx大幅减少到70rpx，让输入框占用更多空间
- **发送按钮显著缩小**：按钮宽度减少到70rpx，字体减少到22rpx，更加紧凑
- **间距优化**：减少输入框与按钮间距到6rpx，移除输入框右边距，最大化输入区域
- **布局优化**：添加min-width: 0确保flex布局正常工作，flex-shrink: 0防止按钮被压缩
- **用户体验提升**：输入框显著更宽，用户可以输入更多内容，发送按钮更紧凑但仍易点击

### 2024年双图层背景切换优化
- **修复首次显示卡顿问题**：解决从开屏进入poem/mountain页面时双图层系统未初始化导致的卡顿问题
- **首次显示逻辑优化**：首次显示时直接设置第一个图层，避免双图层切换动画的延迟
- **预加载缓存同步**：优化全局预加载缓存与本地缓存的同步机制，确保预加载图片立即可用
- **立即预加载第二张**：首次显示完成后立即预加载第二张图片，确保第一次切换时不会卡顿
- **文字优先切换策略**：文字卡片立即切换，背景图延迟100ms切换，确保用户能立即看到内容变化
- **轻量级切换机制**：使用智能延迟（预加载图片50ms，网络图片150ms），平衡性能和体验
- **消除白色闪屏**：通过分步切换和预加载路径优化，大幅减少切换时的白色闪屏问题
- **平滑切换保持**：后续的图片切换仍然使用双图层平滑过渡，保持流畅的视觉体验
- **调试日志完善**：添加详细的预加载、切换和加载完成日志，便于排查和监控图片状态
- **完整方案文档**：创建《双图层背景切换完整方案.md》文档，记录事件监听方案的完整实现

### 2024年主页消息图标功能
- **添加信封图标按钮**：在主页右上角添加信封图标按钮，点击可跳转到消息页面
- **未读消息红点提示**：当有未读消息时，在信封图标右上角显示红色圆点提示
- **实时消息数量检查**：页面显示时自动检查未读消息数量，确保红点状态实时更新
- **磨砂玻璃效果**：消息图标采用磨砂玻璃背景，与整体UI风格保持一致
- **脉冲动画效果**：未读消息红点添加脉冲动画，增强视觉吸引力
- **点击反馈优化**：添加点击缩放效果，提供良好的交互反馈

### 2024年开屏打字机动画效果
- **实现打字机动画**：为开屏页面添加"poementer"文字的打字机动画效果，逐字显示文字
- **人性化打字节奏**：每个字母出现时间有差异，模拟真实人打字的节奏，在"poem"后停顿再继续打"enter"
- **状态管理优化**：通过currentPhase状态控制不同阶段的显示（typing → imageDisplay → done）
- **闪烁光标效果**：添加闪烁光标动画，模拟真实打字机效果
- **进入按钮交互**：打字动画完成后显示"进入"按钮，用户点击后切换到开屏图显示
- **并行预加载机制**：打字机动画与图片预加载并行执行，提升加载效率
- **智能跳转控制**：修复预加载完成后自动跳转的问题，现在必须等待用户点击"进入"按钮才能跳转
- **预加载状态显示**：按钮根据预加载状态显示"进入"或"加载中..."，提供清晰的用户反馈
- **简化用户体验**：暂时注释掉开屏图显示功能，用户点击"进入"按钮后直接跳转到主页，提升启动速度
- **优化视觉风格**：将打字机动画改为白底黑字风格，提供更清爽的视觉效果
- **回车键风格按钮**：将"进入"按钮改为"enter"文字，并设计成类似回车键的样式，包含回车符号图标
- **换行光标交互**：点击enter按钮后，光标换行到下一行居中闪烁两下，然后进入首页，模拟真实的回车键换行效果
- **光标切换优化**：点击enter后自动隐藏原光标，只显示换行后的新光标，避免重复显示
- **平滑动画效果**：enter按钮出现时使用平滑的上移动画，避免闪现，提升视觉体验
- **文字平滑上移**：当enter按钮出现时，文字平滑上移80rpx，避免突然的位置变化
- **按钮绝对定位**：使用绝对定位让enter按钮不占用布局空间，避免文字被"挤"上去的瞬移问题
- **光标间距优化**：调整换行后光标与文字的距离为40rpx，提供更美观的视觉间距
- **分层布局设计**：将文字和按钮放在不同的图层，使用绝对定位让它们完全独立，互不影响
- **光标透明隐藏**：使用透明度变化隐藏原光标，而不是移除元素，确保布局完全稳定
- **平滑过渡动画**：为进入按钮和开屏图显示添加淡入动画，提升用户体验
- **触觉反馈优化**：为进入按钮添加震动反馈，增强交互体验
- **保持原有功能**：完全保留原有的预加载逻辑和页面跳转功能，确保功能完整性

### 2024年自定义tabBar磨砂效果
- **创建自定义tabBar组件**：实现圆角矩形磨砂效果的tabBar，支持半透明背景和毛玻璃效果
- **启用自定义tabBar**：在app.json中设置"custom": true，启用自定义tabBar功能
- **磨砂视觉效果**：使用backdrop-filter: blur(20rpx)实现毛玻璃效果，rgba(255, 255, 255, 0.8)实现半透明背景
- **圆角设计**：50rpx圆角半径，居中悬浮设计，底部留白20rpx
- **阴影效果**：添加box-shadow和边框效果，提升视觉层次感
- **页面集成**：在所有tab页面（广场、路、山、湖）中集成自定义tabBar组件
- **修复图片路径问题**：将图片路径从相对路径改为绝对路径（/images/），解决图片加载失败问题
- **完善点击逻辑**：添加完整的tabBar点击事件处理，支持页面切换和状态更新
- **状态同步机制**：在每个页面的onShow方法中添加tabBar状态更新逻辑，确保选中状态正确显示
- **修复图标绑定问题**：改进路径匹配逻辑，支持多种路径格式，修复点击图标时选中状态错乱的问题
- **添加调试信息**：在tabBar中添加调试文本显示，帮助排查选中状态问题
- **彻底修复状态同步问题**：采用官方推荐的最佳实践，简化tabBar组件逻辑，完全依赖页面的onShow生命周期来设置选中状态，确保状态同步的绝对可靠性
- **修复onShow方法逻辑问题**：解决poem.js和mountain.js中onShow方法的isFirstLoad标志位导致的提前return问题，确保tabBar状态更新始终执行
- **修复语法错误**：修复poem.js和mountain.js中else语句块缺少闭合大括号的语法错误，确保代码正常编译
- **添加详细调试日志**：为所有页面的onShow方法和tabBar组件添加详细的console.log，帮助排查tabBar状态同步问题
- **修复自定义tabBar位置问题**：将custom-tabbar从components文件夹移动到根目录custom-tab-bar，解决getTabBar()找不到组件的根本问题，确保小程序框架能正确识别自定义tabBar
- **统一页面加载体验架构**：按照提示.md建议实施UI渲染与数据请求分离的架构，为所有tab页面添加统一的骨架屏加载体验，poem页面支持预加载数据秒开，其他页面显示骨架屏后异步加载数据
- **完成所有tab页面架构统一**：为广场页（index.js）和个人主页（profile.js）应用相同的架构模式，实现所有四个tab页面的加载体验完全统一，确保用户在任何页面切换时都有一致的体验
- **修复WXML标签闭合错误**：修复index.wxml、profile.wxml、mountain.wxml中多余的闭合标签和缺失的闭合标签导致的编译错误，确保所有WXML文件语法正确
- **修复profile页面WXML编译错误**：修复profile.wxml中sidebar标签结构错误导致的"end tag missing"编译错误，确保页面正常渲染
- **修复mountain页面预加载问题**：修复mountain.js缺少预加载数据检查逻辑的问题，在开屏页面添加mountain页面数据预加载，解决"invalid url"预加载失败错误
- **修复滑动切换时骨架屏问题**：为poem.js和mountain.js添加专门的loadMorePosts函数，避免在滑动切换帖子时显示骨架屏，确保骨架屏只在首次进入页面时使用

### 2024年收藏页面优化
- **修复文字换行问题**：仿照首页广场页面，为收藏页面和profile页面的收藏部分添加`white-space: pre-wrap;`样式，确保文字正确换行显示
- **修复匿名用户显示问题**：修复云函数中的语法错误，确保收藏时正确保存作者信息，获取收藏数据时能正确显示作者姓名和头像
- **完善收藏体验**：统一收藏页面的显示效果，与首页广场页面保持一致的用户体验

### 2024年字数限制优化
- **放宽帖子字数限制**：将发布帖子的字数限制从默认限制放宽到1500字，满足用户发布更长内容的需求
- **添加字数统计显示**：在发布页面添加实时字数统计，显示"当前字数/1500"格式
- **优化输入体验**：为标题输入框设置50字限制，为评论输入框设置200字限制，提供更好的输入体验
- **完善字数提示**：通过maxlength属性确保用户了解字数限制，避免发布时才发现超限

### 2024年UI图标优化
- **重新设计tab图标系统**：将tab图标改为market（广场）、road（路）、mountain（山）、pools（湖），每个都有点击与未点击两种状态
- **完善tab结构**：保持4个tab的完整结构，包括广场、路、山、湖
- **统一图标风格**：所有tab图标使用统一的命名规范和视觉风格

### 2024年开屏预加载优化
- **修复图片路径问题**：将所有本地图片的相对路径改为绝对路径，解决"file not found"错误
- **统一云函数数据字段**：修复splash.js和poem.js中数据字段不一致问题，统一使用posts字段
- **优化预加载机制**：使用wx.downloadFile替代wx.getImageInfo，实现更可靠的图片预加载
- **Promise.all优化时机**：使用Promise.all等待所有预加载任务完成，避免固定setTimeout的弊端
- **全局预加载缓存**：创建app.globalData.preloadedImages全局缓存，实现开屏和poem页面无缝衔接
- **智能跳转机制**：预加载完成后立即跳转，实现"最快加载，无缝跳转"的理想效果
- **修复Promise链条断裂**：解决preloadFirstPostImages异步任务未等待完成就跳转的关键bug
- **移除svg预加载**：小程序不支持svg格式，移除相关预加载避免错误
- **完善异步流程**：使用async/await确保图片下载完成后再跳转，彻底解决闪烁问题
- **修复onLoad与onShow冲突**：使用isFirstLoad标志位避免预加载数据被onShow强制清空
- **解决骨架屏闪烁**：首次加载时onShow跳过刷新逻辑，保持预加载数据，实现真正秒开

### 2024年mountain页面双图层背景优化
- **实现双图层背景切换**：采用两个image标签实现真正的交叉淡入淡出效果，替代无效的background-image过渡
- **独立内容数据管理**：使用currentPost对象替代postList[currentPostIndex]，避免整个卡片重新渲染
- **极致流畅切换体验**：通过opacity透明度控制实现平滑过渡，视觉上更加高级自然
- **性能优化提升**：减少小程序渲染开销，在低端机型上表现更佳
- **代码结构优化**：将updatePostDisplay和switchBackgroundImage逻辑分离，代码更清晰易维护
- **预加载机制保留**：继续使用wx.downloadFile预加载图片到本地，确保切换瞬间完成
- **修复onLoad与onShow冲突**：使用isFirstLoad标志位避免预加载数据被onShow强制清空
- **全局预加载缓存支持**：支持使用开屏预加载的图片缓存，实现无缝衔接

### 2024年poem页面双图层背景优化
- **实现双图层背景切换**：采用两个image标签实现真正的交叉淡入淡出效果，替代无效的background-image过渡
- **独立内容数据管理**：使用currentPost对象替代postList[currentPostIndex]，避免整个卡片重新渲染
- **极致流畅切换体验**：通过opacity透明度控制实现平滑过渡，视觉上更加高级自然
- **性能优化提升**：减少小程序渲染开销，在低端机型上表现更佳
- **代码结构优化**：将updatePostDisplay和switchBackgroundImage逻辑分离，代码更清晰易维护
- **预加载机制保留**：继续使用wx.downloadFile预加载图片到本地，确保切换瞬间完成

### 2024年开屏页面优化
- **修复开屏页面显示问题**：解决小程序启动时直接跳转到poem页面而不显示开屏页面的问题
- **优化页面跳转逻辑**：将自动登录逻辑从app.js移到开屏页面，确保开屏页面正常显示
- **修复图片路径问题**：更正开屏图片的引用路径，确保图片正常加载
- **智能跳转机制**：开屏页面根据用户登录状态智能跳转到相应页面（已登录跳转poem页面，未登录跳转登录页面）
- **预加载优化**：在开屏期间预加载poem页面数据，实现秒开体验
- **平滑切换动画**：添加开屏到poem页面的淡出缩放动画，提升用户体验
- **全屏显示修复**：修复开屏页面左侧缝隙问题，实现完美全屏显示

### 2024年背景切换优化
- **简化背景切换方案**：采用业内标准的双层背景图叠加方案，替代复杂的双缓冲机制
- **优化切换逻辑**：使用简单的opacity过渡，先设置下一张背景图，再切换当前背景图
- **提升过渡效果**：将过渡时间调整为0.5s，使用ease-in-out缓动函数，确保切换更加平滑自然

### 2024年性能优化更新
- **代码清理优化**：移除大量测试代码和调试信息，删除临时文件，提升运行效率
- **背景图显示优化**：poem和mountain页面统一使用压缩图作为背景，避免加载原图，减少流量消耗
- **图片压缩算法加强**：提升压缩率，质量降低到65%，尺寸限制到600px，使用webp格式，大幅减小文件体积
- **预加载机制优化**：精简预加载逻辑，只预加载必要图片，减少内存占用和网络请求
- **云函数性能提升**：清理云函数调试代码，减少不必要的日志输出，提升执行速度

### 2024年首页列表加载优化
- **解决并发请求问题**：禁用onReachBottom，统一使用onPageScroll进行预加载，避免重复请求导致的卡顿
- **优化加载状态管理**：添加isLoadingMore状态，提供明确的"正在加载..."和"没有更多了"UI反馈
- **图片占位高度优化**：为图片添加4:3宽高比占位，防止图片加载完成后的布局抖动和闪烁
- **容器ID优化**：为帖子列表容器添加#post-list-container ID，提高滚动检测的准确性
- **防抖机制优化**：简化onPageScroll的防抖逻辑，减少不必要的DOM查询，提升性能
- **加载锁机制**：使用isLoading状态锁严格防止并发请求，确保数据加载的稳定性
- **修复滑动时骨架屏问题**：区分首次加载和滑动加载，只有首次加载时显示骨架屏，滑动加载更多时只显示底部加载提示
- **修复wx:key重复警告**：强化并发控制，使用严格的"上锁->请求->解锁"流程，彻底杜绝因并发请求导致的数据重复问题
- **修复API废弃警告**：将wx.getSystemInfoSync替换为wx.getWindowInfo，提升代码规范性和性能
- **修复骨架屏逻辑错误**：修正并发控制修复时引入的逻辑错误，确保只有首次加载时显示骨架屏，滑动加载更多时只显示底部提示
- **彻底修复并发请求漏洞**：同时检查isLoading和isLoadingMore状态，确保任何时候只有一个请求在进行，彻底杜绝数据重复问题
- **激活图片占位方案**：在WXML中使用JS生成的imageStyle，通过padding-bottom技巧实现4:3宽高比占位，彻底解决图片加载导致的布局抖动和闪烁
- **优化图片容器布局**：采用"父相子绝"布局方式，图片容器通过padding-bottom撑开占位空间，内部图片绝对定位填充，确保布局稳定
- **增强tab栏磨砂效果**：降低自定义tab栏背景不透明度从0.8到0.6，增强毛玻璃视觉效果，让背景内容更加清晰可见

### 2024年标签功能实现
- **发布页面标签选择**：在发布页面添加标签选择功能，支持预设标签和自定义标签输入，最多选择5个标签
- **首页标签显示**：在广场页面显示帖子标签，支持点击标签进行筛选（预留功能接口）
- **详情页标签显示**：在帖子详情页显示标签，支持点击标签跳转（预留功能接口）
- **专注模式保持**：poem和mountain页面不显示标签，保持阅读专注体验
- **数据库结构扩展**：为posts集合添加tags字段，支持标签数据存储和查询
- **云函数标签支持**：更新getPostList和getPostDetail云函数，支持标签字段的查询和返回
- **标签样式设计**：采用蓝色主题的标签样式（#24375f），让标签看起来更像可点击的按钮，提升用户交互体验
- **标签点击冒泡问题修复**：使用catchtap阻止标签点击事件冒泡，确保点击标签只进入标签筛选页，不触发详情页跳转
- **评论emoji点击功能**：为评论emoji添加点击事件，点击可正常进入详情页，实现标签和评论的独立交互逻辑
- **标签页图片显示修复**：修复标签筛选页图片不显示的问题，添加imageStyle样式设置和正确的图片容器布局，确保图片能正常显示和预览
- **搜索功能实现**：在首页顶部添加搜索框组件，创建完整的搜索页面，支持按文字搜索帖子，包含搜索历史、热门搜索、图片预览等完整功能
- **搜索bug修复**：修复搜索关键词数据不一致的问题，确保搜索输入、确认、历史记录选择等功能使用正确的关键词
- **搜索体验优化**：添加防抖机制，输入500ms后自动搜索，优化界面显示逻辑，确保搜索结果实时更新，解决显示上一次搜索结果的问题

### 2024年功能更新
- **个人中心收藏显示**：在个人中心添加收藏标签，可查看所有收藏内容，按时间排序
- **收藏作者信息修复**：修复收藏列表显示"匿名用户"的问题，正确显示作者姓名和头像
- **用户个人主页功能**：点击头像可进入用户个人主页，查看TA的帖子和个性签名
- **独立用户主页页面**：创建专门的用户主页页面，提供更好的浏览体验
- **动态点赞图标系统**：实现根据点赞数动态显示不同图标的点赞按钮，3以下显示种子，4-7显示叶子，8-15显示花，15以上显示果实，已点赞状态显示对应的高亮版本

### 2024年主页左滑右滑切换功能
- **实现页面切换逻辑**：在index页面（广场）添加左滑右滑切换功能，左滑进入发现页，右滑回到主页
- **边缘滑动检测**：通过检测触摸起始位置判断是否为边缘滑动（左边缘10%或右边缘10%），避免与正常滑动冲突
- **页面状态管理**：添加currentPage状态管理主页和发现页的切换，支持独立的数据列表和分页
- **切换动画提示**：在页面顶部添加切换提示组件，显示"发现页"或"主页"文字，3秒后自动消失
- **发现页数据加载**：为发现页创建独立的数据加载逻辑，支持推荐算法参数（sortBy: 'recommendation'）
- **双列表管理**：主页使用postList，发现页使用discoverPostList，各自独立管理分页和加载状态
- **触摸事件处理**：添加touchStart和touchEnd事件处理，计算滑动距离和角度，确保只有水平滑动才触发切换
- **UI样式优化**：为页面切换提示添加磨砂玻璃效果和淡入动画，提升视觉体验
- **发现页布局**：发现页使用与主页相同的帖子列表布局，保持一致的用户体验
- **空状态处理**：为发现页添加专门的空状态提示"发现页暂无内容，推荐算法正在学习中..."

### 2024年发现页推荐算法实现
- **个性化推荐算法**：基于用户点赞、评论、浏览记录，推荐相似作者和标签的内容
- **热门推荐算法**：基于点赞数和评论数计算热度分，推荐社区热门内容
- **混合推荐策略**：按3:2比例混合个性化和热门推荐，确保内容多样性和相关性
- **防重复机制**：记录已显示的帖子ID，避免重复推荐相同内容
- **固定数量显示**：发现页固定显示5个帖子，刷完后显示"没有更多了"提示
- **下拉刷新功能**：支持下拉刷新重新获取推荐，每次刷新都会重新排序
- **浏览记录收集**：自动记录用户浏览帖子的时长，用于个性化推荐
- **推荐类型标记**：为每个推荐帖子添加类型标记（个性化/热门/最新）和推荐理由
- **性能优化**：使用云函数聚合查询，减少数据库请求次数，提升响应速度
- **图片显示修复**：修复发现页图片不显示的问题，完善图片URL转换和样式处理逻辑
- **推荐算法优化**：修复推荐算法返回0个帖子的问题，当个性化推荐为空时自动用热门帖子填充，确保发现页始终有内容显示
- **滑动判断优化**：参考poem页面的滑动逻辑，简化主页发现页的左右滑动判断，移除复杂的边缘检测，使用更直观的滑动距离和角度判断

## 参考文档

- [云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)

