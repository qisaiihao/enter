# 关注功能实现方案

这是一个为“回车键”小程序设计的关注功能实现方案。方案涵盖了从后端数据结构到前端页面实现，并提供了一些提升用户体验的额外建议。

---

## 一、 核心思路

我们将通过微信小程序的云开发能力来实现此功能，主要依赖 **云数据库** 和 **云函数**。

1.  **数据存储**：在云数据库中创建一个新的集合（类似SQL中的表），专门用来存储用户之间的关注关系。
2.  **逻辑处理**：创建几个云函数来处理关注、取关、获取关注列表等核心逻辑，确保安全和效率。
3.  **前端展示**：修改现有页面（详情页、我的）并创建新页面（我关注的列表页）来展示功能。

---

## 二、 后端数据结构设计

### 1. 创建云数据库集合

首先，你需要在微信开发者工具的“云开发控制台”中手动创建一个新的数据库集合。

-   **集合名称**：`follows`

**请注意**：需要提醒我，在后续操作中，如果这个集合不存在，我会提示你手动创建。

### 2. `follows` 集合的文档结构

每条记录（文档）代表一个关注关系。

```json
{
  "_id": "自动生成的唯一ID",
  "follower_openid": "发起关注者的_openid", // 也就是当前用户的 openid
  "followee_openid": "被关注者的_openid",   // 对方用户的 openid
  "create_time": "关注发生时的时间戳"      // 用于排序或分析
}
```

### 3. 数据库索引

为了提高查询效率，建议为 `follows` 集合创建索引：

-   在 `follower_openid` 字段上创建索引，可以快速查找某个用户关注的所有人。
-   创建一个 `(follower_openid, followee_openid)` 的复合唯一索引，可以防止用户重复关注同一个人。

### 4. 云函数设计

我们将创建以下几个云函数来处理所有与关注相关的数据库操作。

-   `operateFollow(targetUserId, action)`
    -   **功能**：处理关注和取消关注。
    -   **参数**：
        -   `targetUserId` (string): 被操作用户的 `_openid`。
        -   `action` (string): 操作类型，`'follow'` 或 `'unfollow'`。
    -   **逻辑**：
        -   `follow`: 在 `follows` 集合中添加一条新记录。
        -   `unfollow`: 从 `follows` 集合中删除对应的记录。

-   `getFollowingList()`
    -   **功能**：获取当前用户关注的所有人的列表。
    -   **逻辑**：查询 `follows` 集合，找出所有 `follower_openid` 为当前用户 `_openid` 的记录。然后，利用这些记录中的 `followee_openid`，去 `users` 集合（或其他存储用户信息的集合）中查询这些被关注用户的详细信息（昵称、头像、个性签名）。

-   `checkFollowStatus(targetUserId)`
    -   **功能**：检查当前用户是否已关注某个特定用户。
    -   **参数**：`targetUserId` (string): 目标用户的 `_openid`。
    -   **逻辑**：在 `follows` 集合中查询是否存在 `follower_openid` 为当前用户 `_openid` 且 `followee_openid` 为 `targetUserId` 的记录。返回 `true` 或 `false`。

---

## 三、 前端实现步骤

### 1. 详情页 - 添加关注按钮

-   **目标文件**：`pages/detail/detail.wxml` 和 `pages/detail/detail.js` (假设这是你的详情页路径)
-   **WXML 修改**：
    在“收藏”按钮旁边，添加一个新的“关注”按钮。
    ```html
    <!-- detail.wxml -->
    <view class="actions">
      <button class="favorite-btn">收藏</button>
      <!-- 新增关注按钮 -->
      <button 
        class="follow-btn" 
        bindtap="onFollowTap"
        data-isfollowing="{{isFollowing}}">
        {{ isFollowing ? '已关注' : '+ 关注' }}
      </button>
    </view>
    ```
-   **JS 修改**：
    ```javascript
    // detail.js
    Page({
      data: {
        isFollowing: false, // 默认未关注
        postOwnerId: null // 帖子作者的 openid
      },

      onLoad: function(options) {
        // 假设从 options 或其他途径获取到了帖子作者的ID
        const postOwnerId = '...'; 
        this.setData({ postOwnerId });
        this.checkIfFollowing(postOwnerId);
      },

      // 检查关注状态
      checkIfFollowing: function(targetUserId) {
        wx.cloud.callFunction({
          name: 'checkFollowStatus',
          data: { targetUserId: targetUserId },
          success: res => {
            this.setData({ isFollowing: res.result.isFollowing });
          }
        });
      },

      // 点击关注/取关按钮
      onFollowTap: function() {
        const action = this.data.isFollowing ? 'unfollow' : 'follow';
        wx.cloud.callFunction({
          name: 'operateFollow',
          data: {
            targetUserId: this.data.postOwnerId,
            action: action
          },
          success: res => {
            // 操作成功后，更新按钮状态
            this.setData({ isFollowing: !this.data.isFollowing });
            wx.showToast({
              title: action === 'follow' ? '关注成功' : '已取消关注',
              icon: 'none'
            });
          }
        });
      }
    });
    ```

### 2. 我的页面 - 添加入口

-   **目标文件**：`pages/my/my.wxml` 和 `pages/my/my.js` (假设路径)
-   **WXML 修改**：
    在侧边抽屉或个人中心的功能列表中，添加一个“我关注的”入口。
    ```html
    <!-- my.wxml -->
    <view class="drawer-item" bindtap="navigateToFollowing">
      <text>我关注的</text>
    </view>
    ```
-   **JS 修改**：
    ```javascript
    // my.js
    Page({
      // ...
      navigateToFollowing: function() {
        wx.navigateTo({
          url: '/pages/followingList/followingList' // 跳转到关注列表页
        });
      }
    });
    ```

### 3. 创建“我关注的”列表页

-   **创建新页面**：在 `pages` 目录下创建一个新页面 `followingList`。
-   **`followingList.json`**：
    ```json
    {
      "usingComponents": {},
      "navigationBarTitleText": "我关注的人"
    }
    ```
-   **`followingList.wxml`**：
    ```html
    <view class="container">
      <view wx:if="{{ followingList.length === 0 }}" class="empty-tip">
        你还没有关注任何人哦~
      </view>
      <view 
        wx:for="{{followingList}}" 
        wx:key="_id" 
        class="user-card" 
        bindtap="goToUserProfile" 
        data-userid="{{item._openid}}">
        <image class="avatar" src="{{item.avatarUrl}}"></image>
        <view class="user-info">
          <view class="nickname">{{item.nickName}}</view>
          <view class="signature">{{item.signature || '这个人很懒，什么都没留下'}}</view>
        </view>
      </view>
    </view>
    ```
-   **`followingList.js`**：
    ```javascript
    // followingList.js
    Page({
      data: {
        followingList: []
      },

      onLoad: function (options) {
        this.loadFollowingList();
      },

      loadFollowingList: function() {
        wx.showLoading({ title: '加载中...' });
        wx.cloud.callFunction({
          name: 'getFollowingList',
          success: res => {
            this.setData({ followingList: res.result.list });
          },
          fail: console.error,
          complete: () => {
            wx.hideLoading();
          }
        });
      },

      goToUserProfile: function(e) {
        const userId = e.currentTarget.dataset.userid;
        // 这里需要根据你的项目结构，跳转到对应的用户主页
        wx.navigateTo({
          url: `/pages/userProfile/userProfile?userId=${userId}`
        });
      }
    });
    ```

---

## 四、 其他与关注功能相关的体验优化建议

1.  **粉丝列表**：既然有“我关注的”，自然也应该有“我的粉丝”。可以创建一个类似的页面，展示关注了你的人。这需要一个新的云函数 `getFollowerList`。

2.  **互相关注状态**：在关注列表或用户主页，可以显示“互相关注”的状态，增强社交联系感。这可以在 `getFollowingList` 和 `checkFollowStatus` 的逻辑中进行扩展。

3.  **新粉丝提醒**：当有新用户关注你时，可以在“我的”页面或消息中心显示一个小红点或发送一条系统通知，给予用户即时反馈。

4.  **“关注”动态流**：在首页或一个独立的Tab页，创建一个“关注”信息流。这个页面只显示你所关注的人发布的内容，这是关注功能最核心的价值体现。

5.  **推荐关注**：根据你关注的人，或你们的共同好友，为用户推荐可能感兴趣的人。例如，“你关注的 XXX 也关注了 YYY”。

6.  **取消关注的二次确认**：为了防止误操作，当用户点击“已关注”按钮时，可以弹出一个确认框，询问“确定要取消关注吗？”。
