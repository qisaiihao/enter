<!--pages/messages/messages.wxml-->
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">æ¶ˆæ¯é€šçŸ¥</text>
    <view class="header-actions">
      <text wx:if="{{unreadCount > 0}}" class="unread-count">{{unreadCount}}æ¡æœªè¯»</text>
      <text class="clear-btn" bindtap="clearAllMessages">æ¸…ç©º</text>
    </view>
  </view>

  <!-- æ¶ˆæ¯ç±»å‹æ ‡ç­¾ -->
  <view class="tab-container">
    <view class="tab-item {{activeTab === 'all' ? 'active' : ''}}" bindtap="switchTab" data-tab="all">
      <text>å…¨éƒ¨</text>
      <view wx:if="{{activeTab === 'all'}}" class="tab-indicator"></view>
    </view>
    <view class="tab-item {{activeTab === 'like' ? 'active' : ''}}" bindtap="switchTab" data-tab="like">
      <text>ç‚¹èµ</text>
      <view wx:if="{{activeTab === 'like'}}" class="tab-indicator"></view>
    </view>
    <view class="tab-item {{activeTab === 'comment' ? 'active' : ''}}" bindtap="switchTab" data-tab="comment">
      <text>è¯„è®º</text>
      <view wx:if="{{activeTab === 'comment'}}" class="tab-indicator"></view>
    </view>
    <view class="tab-item {{activeTab === 'favorite' ? 'active' : ''}}" bindtap="switchTab" data-tab="favorite">
      <text>æ”¶è—</text>
      <view wx:if="{{activeTab === 'favorite'}}" class="tab-indicator"></view>
    </view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view scroll-y="true" class="message-list" bindscrolltolower="onReachBottom">
    <view wx:if="{{messages.length === 0 && !isLoading}}" class="empty-container">
      <image class="empty-icon" src="../../images/icons/empty-message.svg" mode="aspectFit"></image>
      <text class="empty-text">æš‚æ— æ¶ˆæ¯é€šçŸ¥</text>
    </view>

    <view wx:for="{{messages}}" wx:key="_id" wx:for-index="index" class="message-item {{!item.isRead ? 'unread' : ''}}">
      <!-- æ¶ˆæ¯å†…å®¹ -->
      <view class="message-content" bindtap="navigateToPost" data-postid="{{item.postId}}">
        <!-- ç”¨æˆ·å¤´åƒ -->
        <image class="user-avatar" src="{{item.fromUserAvatar || '../../images/avatar.png'}}" mode="aspectFill"></image>
        
        <!-- æ¶ˆæ¯ä¸»ä½“ -->
        <view class="message-body">
          <!-- æ¶ˆæ¯ç±»å‹å›¾æ ‡å’Œæ ‡é¢˜ -->
          <view class="message-header">
            <view class="message-type">
              <text class="type-icon">{{item.type === 'like' ? 'ğŸ‘' : item.type === 'comment' ? 'ğŸ’¬' : 'â­'}}</text>
              <text class="type-text">{{item.type === 'like' ? 'ç‚¹èµ' : item.type === 'comment' ? 'è¯„è®º' : 'æ”¶è—'}}</text>
            </view>
          </view>
          
          <!-- æ¶ˆæ¯æ–‡æœ¬ï¼ˆåŒ…å«æ—¶é—´ä¿¡æ¯ï¼‰ -->
          <text class="message-text">{{item.content}}</text>
          
          <!-- ç›¸å…³å¸–å­é¢„è§ˆ -->
          <view wx:if="{{item.postTitle}}" class="post-preview">
            <text class="post-title">{{item.postTitle}}</text>
          </view>
        </view>
      </view>
      
      <!-- åˆ é™¤æŒ‰é’® -->
      <view class="delete-btn" bindtap="deleteMessage" data-messageid="{{item._id}}" data-index="{{index}}">
        <text>åˆ é™¤</text>
      </view>
      
      <!-- æœªè¯»æ ‡è®° -->
      <view wx:if="{{!item.isRead}}" class="unread-dot"></view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{isLoading && messages.length > 0}}" class="loading-more">
      <text>åŠ è½½ä¸­...</text>
    </view>
    
    <!-- æ²¡æœ‰æ›´å¤š -->
    <view wx:if="{{!hasMore && messages.length > 0}}" class="no-more">
      <text>æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†</text>
    </view>
  </scroll-view>
</view>