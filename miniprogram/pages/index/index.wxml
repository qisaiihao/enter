<!-- index.wxml -->
<view class="container">
  <!-- 消息图标按钮 -->
  <view class="message-icon-container" bindtap="navigateToMessages">
    <view class="message-icon">✉️</view>
    <view wx:if="{{unreadMessageCount > 0}}" class="unread-dot"></view>
  </view>

  <!-- 骨架屏：当 isLoading 为 true 时显示 -->
  <view wx:if="{{isLoading}}">
    <skeleton />
  </view>

  <!-- 真实内容：当 isLoading 为 false 时显示 -->
  <view wx:else class="square-mode-container">
    <view wx:if="{{postList.length === 0 && !isLoading}}" class="empty-state">
      <view class="empty-icon">📝</view>
      <view class="empty-text">还没有帖子哦～</view>
      <view class="empty-subtext">快来发布第一条帖子吧！</view>
    </view>
    <!-- 给你的帖子列表循环的父容器添加一个ID -->
    <view id="post-list-container">
      <view 
        wx:for="{{postList}}" 
        wx:key="_id" 
        wx:for-index="index"
        class="post-item-wrapper"
      >
        <!-- 作者信息 -->
        <view class="author-info-outside">
          <image wx:if="{{item.authorAvatar}}" class="author-avatar" src="{{item.authorAvatar}}" mode="aspectFill" binderror="onAvatarError" bindload="onAvatarLoad" data-postindex="{{index}}" catch:tap="navigateToUserProfile" data-user-id="{{item._openid}}"></image>
          <text class="author-name">{{item.authorName}}</text>
        </view>
        
        <!-- 可点击的内容区域 - 跳转到详情页 -->
        <navigator 
          class="post-content-navigator"
          url="/pages/post-detail/post-detail?id={{item._id}}"
          hover-class="navigator-hover"
        >
          <view class="post-item">
            <view class="post-title">{{item.title}}</view>
            
            <!-- 图片显示逻辑 (已优化，使用 imageStyle 占位) -->
            <view wx:if="{{(item.imageUrls && item.imageUrls.length > 0)}}" 
                  class="image-container-wrapper" 
                  style="{{item.imageStyle}}" 
                  catch:tap="handlePreview" 
                  data-src="{{item.imageUrls[0]}}"
                  data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}">

              <!-- 单张图片 -->
              <block wx:if="{{item.imageUrls.length === 1}}">
                <image
                  class="post-image"
                  src="{{item.imageUrls[0]}}"
                  mode="aspectFill"
                  lazy-load="{{true}}"
                  binderror="onImageError"
                />
              </block>

              <!-- 多张图片 -->
              <block wx:elif="{{item.imageUrls.length > 1}}">
                <swiper class="image-swiper" indicator-dots="true" circular="true">
                  <block wx:for="{{item.imageUrls}}" wx:for-item="img" wx:key="*this">
                    <swiper-item>
                      <image
                        class="post-image"
                        src="{{img}}"
                        mode="aspectFill"
                        lazy-load="{{true}}"
                        binderror="onImageError"
                        catch:tap="handlePreview"
                        data-src="{{img}}"
                        data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                      />
                    </swiper-item>
                  </block>
                </swiper>
              </block>
            </view>
              
            <view class="post-content" wx:if="{{item.content}}" style="white-space: pre-wrap;">{{item.content}}</view>
            
            <!-- 标签显示 -->
            <view wx:if="{{item.tags && item.tags.length > 0}}" class="post-tags">
              <text wx:for="{{item.tags}}" wx:key="index" 
                    class="post-tag" 
                    bindtap="onTagClick" 
                    data-tag="{{item}}">#{{item}}</text>
            </view>
          </view>
        </navigator>

        <!-- 独立的互动区域 - 不触发详情页跳转 -->
        <view class="vote-section">
          <view class="actions-left">
            <!-- 左侧留空，保持布局平衡 -->
          </view>
          <view class="button-group">
            <view class="comment-count">
              <text class="action-emoji">💬</text>
              <text class="action-text">{{item.commentCount || 0}}</text>
            </view>
            <view class="like-icon-container" catch:tap="onVote" data-postid="{{item._id}}" data-index="{{index}}">
              <image class="like-icon" src="{{item.likeIcon || '/images/seed.png'}}" mode="aspectFit" binderror="onLikeIconError"></image>
            </view>
            <view class="vote-count {{item.isVoted ? 'voted' : ''}}">
              <text class="action-text">{{item.votes || 0}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 在容器外部，页面的最底部添加加载提示 -->
    <view class="loading-footer">
      <block wx:if="{{isLoadingMore}}">
        <text>正在加载...</text>
      </block>
      <block wx:elif="{{!hasMore && postList.length > 0}}">
        <text>--- 我是有底线的 ---</text>
      </block>
    </view>
  </view>

  <!-- 悬浮的发布按钮 -->
  <navigator url="/pages/add/add" class="add-button">
    <view>+</view>
  </navigator>

  <!-- 调试按钮 (仅在开发环境显示) -->
  <view wx:if="{{false}}" class="debug-button" bindtap="testImageUrls">
    <view>🐛</view>
  </view>
</view>

<!-- 自定义tabBar -->
<custom-tabbar />