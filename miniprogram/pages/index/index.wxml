<!-- index.wxml -->
<view class="container">
  <!-- éª¨æ¶å±ï¼šå½“ isLoading ä¸º true æ—¶æ˜¾ç¤º -->
  <view wx:if="{{isLoading}}">
    <skeleton />
  </view>

  <!-- çœŸå®å†…å®¹ï¼šå½“ isLoading ä¸º false æ—¶æ˜¾ç¤º -->
  <view wx:else class="square-mode-container">
    <view wx:if="{{postList.length === 0 && !isLoading}}" class="empty-state">
      <view class="empty-icon">ğŸ“</view>
      <view class="empty-text">è¿˜æ²¡æœ‰å¸–å­å“¦ï½</view>
      <view class="empty-subtext">å¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å¸–å­å§ï¼</view>
    </view>
    <!-- ç»™ä½ çš„å¸–å­åˆ—è¡¨å¾ªç¯çš„çˆ¶å®¹å™¨æ·»åŠ ä¸€ä¸ªID -->
    <view id="post-list-container">
      <view wx:for="{{postList}}" wx:key="_id" class="post-item-wrapper">
      <!-- ä½œè€…ä¿¡æ¯æ”¾åœ¨navigatorå¤–é¢ï¼Œé¿å…äº‹ä»¶å†²çª -->
      <view class="author-info-outside">
        <image wx:if="{{item.authorAvatar}}" class="author-avatar" src="{{item.authorAvatar}}" mode="aspectFill" binderror="onAvatarError" bindload="onAvatarLoad" data-postindex="{{index}}" bindtap="navigateToUserProfile" data-user-id="{{item._openid}}"></image>
        <text class="author-name">{{item.authorName}}</text>
      </view>
      <navigator 
        class="post-item"
        url="/pages/post-detail/post-detail?id={{item._id}}"
        hover-class="post-item-active"
      >
      
        <view class="post-title">{{item.title}}</view>
        
        <!-- å›¾ç‰‡æ˜¾ç¤ºé€»è¾‘ (å·²ä¼˜åŒ–ï¼Œä½¿ç”¨ imageStyle å ä½) -->
        <view wx:if="{{(item.imageUrls && item.imageUrls.length > 0)}}" 
              class="image-container-wrapper" 
              style="{{item.imageStyle}}" 
              catch:tap="handlePreview" 
              data-src="{{item.imageUrls[0]}}"
              data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}">

          <!-- å•å¼ å›¾ç‰‡ -->
          <block wx:if="{{item.imageUrls.length === 1}}">
            <image
              class="post-image"
              src="{{item.imageUrls[0]}}"
              mode="aspectFill"
              lazy-load="{{true}}"
              binderror="onImageError"
            />
          </block>

          <!-- å¤šå¼ å›¾ç‰‡ -->
          <block wx:elif="{{item.imageUrls.length > 1}}">
            <swiper class="image-swiper" indicator-dots="true" circular="true">
              <block wx:for="{{item.imageUrls}}" wx:for-item="img" wx:key="*this">
                <swiper-item>
                  <image
                    class="post-image"
                    src="{{img}}"
                    mode="aspectFill"
                    lazy-load="{{true}}"
                    binderror="onImageError"
                    catch:tap="handlePreview"
                    data-src="{{img}}"
                    data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                  />
                </swiper-item>
              </block>
            </swiper>
          </block>
        </view>
          
        <view class="post-content" wx:if="{{item.content}}" style="white-space: pre-wrap;">{{item.content}}</view>

        <view class="vote-section">
          <view class="actions-left">
            <view class="vote-count {{item.isVoted ? 'voted' : ''}}">ğŸ‘ {{item.votes || 0}}</view>
            <view class="comment-count">ğŸ’¬ {{item.commentCount || 0}}</view>
          </view>
          <view class="button-group">
            <button class="vote-button {{item.isVoted ? 'voted' : ''}}" size="mini" catch:tap="onVote" data-postid="{{item._id}}" data-index="{{index}}">
              {{item.isVoted ? 'å·²ç‚¹èµ' : 'ç‚¹èµ'}}
            </button>
          </view>
        </view>
      </navigator>
      </view>
    </view>
    
    <!-- åœ¨å®¹å™¨å¤–éƒ¨ï¼Œé¡µé¢çš„æœ€åº•éƒ¨æ·»åŠ åŠ è½½æç¤º -->
    <view class="loading-footer">
      <block wx:if="{{isLoadingMore}}">
        <text>æ­£åœ¨åŠ è½½...</text>
      </block>
      <block wx:elif="{{!hasMore && postList.length > 0}}">
        <text>--- æˆ‘æ˜¯æœ‰åº•çº¿çš„ ---</text>
      </block>
    </view>
  </view>

  <!-- æ‚¬æµ®çš„å‘å¸ƒæŒ‰é’® -->
  <navigator url="/pages/add/add" class="add-button">
    <view>+</view>
  </navigator>

  <!-- è°ƒè¯•æŒ‰é’® (ä»…åœ¨å¼€å‘ç¯å¢ƒæ˜¾ç¤º) -->
  <view wx:if="{{false}}" class="debug-button" bindtap="testImageUrls">
    <view>ğŸ›</view>
  </view>
</view>

<!-- è‡ªå®šä¹‰tabBar -->
<custom-tabbar />