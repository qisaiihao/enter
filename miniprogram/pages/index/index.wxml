<!-- index.wxml -->
<view class="container">
  <!-- æ¶ˆæ¯å›¾æ ‡æŒ‰é’® -->
  <view class="message-icon-container" bindtap="navigateToMessages">
    <view class="message-icon">âœ‰ï¸</view>
    <view wx:if="{{unreadMessageCount > 0}}" class="unread-dot"></view>
  </view>

  <!-- éª¨æ¶å±ï¼šå½“ isLoading ä¸º true æ—¶æ˜¾ç¤º -->
  <view wx:if="{{isLoading}}">
    <skeleton />
  </view>

  <!-- çœŸå®å†…å®¹ï¼šå½“ isLoading ä¸º false æ—¶æ˜¾ç¤º -->
  <view wx:else class="square-mode-container">
    <view wx:if="{{postList.length === 0 && !isLoading}}" class="empty-state">
      <view class="empty-icon">ğŸ“</view>
      <view class="empty-text">è¿˜æ²¡æœ‰å¸–å­å“¦ï½</view>
      <view class="empty-subtext">å¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å¸–å­å§ï¼</view>
    </view>
    <!-- ç»™ä½ çš„å¸–å­åˆ—è¡¨å¾ªç¯çš„çˆ¶å®¹å™¨æ·»åŠ ä¸€ä¸ªID -->
    <view id="post-list-container">
      <view 
        wx:for="{{postList}}" 
        wx:key="_id" 
        wx:for-index="index"
        class="post-item-wrapper"
      >
        <!-- ä½œè€…ä¿¡æ¯ -->
        <view class="author-info-outside">
          <image wx:if="{{item.authorAvatar}}" class="author-avatar" src="{{item.authorAvatar}}" mode="aspectFill" binderror="onAvatarError" bindload="onAvatarLoad" data-postindex="{{index}}" catch:tap="navigateToUserProfile" data-user-id="{{item._openid}}"></image>
          <text class="author-name">{{item.authorName}}</text>
        </view>
        
        <!-- å¯ç‚¹å‡»çš„å†…å®¹åŒºåŸŸ - è·³è½¬åˆ°è¯¦æƒ…é¡µ -->
        <navigator 
          class="post-content-navigator"
          url="/pages/post-detail/post-detail?id={{item._id}}"
          hover-class="navigator-hover"
        >
          <view class="post-item">
            <view class="post-title">{{item.title}}</view>
            
            <!-- å›¾ç‰‡æ˜¾ç¤ºé€»è¾‘ (å·²ä¼˜åŒ–ï¼Œä½¿ç”¨ imageStyle å ä½) -->
            <view wx:if="{{(item.imageUrls && item.imageUrls.length > 0)}}" 
                  class="image-container-wrapper" 
                  style="{{item.imageStyle}}" 
                  catch:tap="handlePreview" 
                  data-src="{{item.imageUrls[0]}}"
                  data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}">

              <!-- å•å¼ å›¾ç‰‡ -->
              <block wx:if="{{item.imageUrls.length === 1}}">
                <image
                  class="post-image"
                  src="{{item.imageUrls[0]}}"
                  mode="aspectFill"
                  lazy-load="{{true}}"
                  binderror="onImageError"
                />
              </block>

              <!-- å¤šå¼ å›¾ç‰‡ -->
              <block wx:elif="{{item.imageUrls.length > 1}}">
                <swiper class="image-swiper" indicator-dots="true" circular="true">
                  <block wx:for="{{item.imageUrls}}" wx:for-item="img" wx:key="*this">
                    <swiper-item>
                      <image
                        class="post-image"
                        src="{{img}}"
                        mode="aspectFill"
                        lazy-load="{{true}}"
                        binderror="onImageError"
                        catch:tap="handlePreview"
                        data-src="{{img}}"
                        data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                      />
                    </swiper-item>
                  </block>
                </swiper>
              </block>
            </view>
              
            <view class="post-content" wx:if="{{item.content}}" style="white-space: pre-wrap;">{{item.content}}</view>
            
            <!-- æ ‡ç­¾æ˜¾ç¤º -->
            <view wx:if="{{item.tags && item.tags.length > 0}}" class="post-tags">
              <text wx:for="{{item.tags}}" wx:key="index" 
                    class="post-tag" 
                    bindtap="onTagClick" 
                    data-tag="{{item}}">#{{item}}</text>
            </view>
          </view>
        </navigator>

        <!-- ç‹¬ç«‹çš„äº’åŠ¨åŒºåŸŸ - ä¸è§¦å‘è¯¦æƒ…é¡µè·³è½¬ -->
        <view class="vote-section">
          <view class="actions-left">
            <!-- å·¦ä¾§ç•™ç©ºï¼Œä¿æŒå¸ƒå±€å¹³è¡¡ -->
          </view>
          <view class="button-group">
            <view class="comment-count">
              <text class="action-emoji">ğŸ’¬</text>
              <text class="action-text">{{item.commentCount || 0}}</text>
            </view>
            <view class="like-icon-container" catch:tap="onVote" data-postid="{{item._id}}" data-index="{{index}}">
              <image class="like-icon" src="{{item.likeIcon || '/images/seed.png'}}" mode="aspectFit" binderror="onLikeIconError"></image>
            </view>
            <view class="vote-count {{item.isVoted ? 'voted' : ''}}">
              <text class="action-text">{{item.votes || 0}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åœ¨å®¹å™¨å¤–éƒ¨ï¼Œé¡µé¢çš„æœ€åº•éƒ¨æ·»åŠ åŠ è½½æç¤º -->
    <view class="loading-footer">
      <block wx:if="{{isLoadingMore}}">
        <text>æ­£åœ¨åŠ è½½...</text>
      </block>
      <block wx:elif="{{!hasMore && postList.length > 0}}">
        <text>--- æˆ‘æ˜¯æœ‰åº•çº¿çš„ ---</text>
      </block>
    </view>
  </view>

  <!-- æ‚¬æµ®çš„å‘å¸ƒæŒ‰é’® -->
  <navigator url="/pages/add/add" class="add-button">
    <view>+</view>
  </navigator>

  <!-- è°ƒè¯•æŒ‰é’® (ä»…åœ¨å¼€å‘ç¯å¢ƒæ˜¾ç¤º) -->
  <view wx:if="{{false}}" class="debug-button" bindtap="testImageUrls">
    <view>ğŸ›</view>
  </view>
</view>

<!-- è‡ªå®šä¹‰tabBar -->
<custom-tabbar />