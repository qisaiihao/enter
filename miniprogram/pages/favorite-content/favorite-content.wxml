<!--pages/favorite-content/favorite-content.wxml-->
<view class="container">
  <!-- 初始加载状态 -->
  <view wx:if="{{isLoading && favorites.length === 0}}" class="loading-container">
    <view class="loading-text">加载中...</view>
  </view>

  <!-- 收藏内容列表 -->
  <view wx:elif="{{favorites.length > 0}}" class="favorites-container">
    <view 
      wx:for="{{favorites}}" 
      wx:key="_id" 
      wx:for-index="index"
      class="post-item-wrapper {{item.isOriginal ? 'original-post' : ''}}"
    >
      <!-- 作者信息 -->
      <view class="author-info-outside">
        <image wx:if="{{item.postAuthorAvatar}}" 
               class="author-avatar" 
               src="{{item.postAuthorAvatar}}" 
               mode="aspectFill" 
               binderror="onAvatarError" 
               bindload="onAvatarLoad" 
               data-postindex="{{index}}" 
               catch:tap="navigateToUserProfile" 
               data-user-id="{{item.postAuthorOpenid}}" />
        <text class="author-name">{{item.postAuthorName}}</text>
      </view>
      
      <!-- 可点击的内容区域 - 跳转到详情页 -->
      <navigator 
        class="post-content-navigator"
        url="/pages/post-detail/post-detail?id={{item.postId}}"
        hover-class="navigator-hover"
      >
        <view class="post-item">
          <view class="post-title">{{item.postTitle}}</view>
          <!-- 诗歌作者信息 -->
          <view wx:if="{{item.postIsPoem && item.postAuthor}}" class="poem-author">{{item.postAuthor}}</view>
          
          <!-- 图片显示逻辑 (已优化，使用 imageStyle 占位) -->
          <view wx:if="{{(item.imageUrls && item.imageUrls.length > 0)}}" 
                class="image-container-wrapper" 
                style="{{item.imageStyle}}" 
                catch:tap="handlePreview" 
                data-src="{{item.imageUrls[0]}}"
                data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}">

            <!-- 单张图片 -->
            <block wx:if="{{item.imageUrls.length === 1}}">
              <image
                id="single-image-{{item.postId}}"
                class="post-image"
                src="{{item.imageUrls[0]}}"
                mode="aspectFill"
                lazy-load="{{true}}"
                binderror="onImageError"
                bindload="onImageLoad"
                data-postid="{{item.postId}}"
                data-postindex="{{index}}"
                data-imgindex="0"
                data-type="single"
              />
            </block>

            <!-- 多张图片 -->
            <block wx:elif="{{item.imageUrls.length > 1}}">
              <swiper id="swiper-{{item.postId}}" class="image-swiper" indicator-dots="true" circular="true" style="height: {{swiperHeights[index] ? swiperHeights[index] + 'px' : '220px'}};">
                <block wx:for="{{item.imageUrls}}" wx:for-item="img" wx:key="*this" wx:for-index="imgindex">
                  <swiper-item>
                    <image
                      class="post-image"
                      src="{{img}}"
                      mode="aspectFill"
                      lazy-load="{{true}}"
                      binderror="onImageError"
                      bindload="onImageLoad"
                      catch:tap="handlePreview"
                      data-src="{{img}}"
                      data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                      data-postid="{{item.postId}}"
                      data-postindex="{{index}}"
                      data-imgindex="{{imgindex}}"
                      data-type="multi"
                    />
                  </swiper-item>
                </block>
              </swiper>
            </block>
          </view>
            
          <view class="post-content" wx:if="{{item.postContent}}" style="white-space: pre-wrap;">{{item.postContent}}</view>
          
          <!-- 标签显示 -->
          <view wx:if="{{item.postTags && item.postTags.length > 0}}" class="post-tags">
            <text wx:for="{{item.postTags}}" wx:key="index" 
                  class="post-tag" 
                  catchtap="onTagClick" 
                  data-tag="{{item}}">#{{item}}</text>
          </view>
        </view>
      </navigator>

      <!-- 取消收藏按钮区域 -->
      <view class="delete-section">
        <view class="time-left">
          <text class="favorite-time">收藏于 {{item.formattedCreateTime || '未知时间'}}</text>
        </view>
        <view class="button-group">
          <button class="remove-favorite-btn" size="mini" catch:tap="removeFavorite" data-favorite-id="{{item._id}}" data-index="{{index}}">取消收藏</button>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view wx:else class="empty-container">
    <view class="empty-icon">📖</view>
    <view class="empty-text">收藏夹是空的</view>
    <view class="empty-subtext">去发现一些好诗收藏起来吧</view>
    <button bindtap="manualLoad" style="margin-top: 20rpx; padding: 15rpx 30rpx; background: #07c160; color: white; border-radius: 8rpx; font-size: 26rpx;">刷新</button>
  </view>

  <!-- 加载更多 -->
  <view wx:if="{{favorites.length > 0 && isLoading}}" class="loading-more">
    <view class="loading-text">加载中...</view>
  </view>

  <!-- 没有更多 -->
  <view wx:if="{{favorites.length > 0 && !hasMore && !isLoading}}" class="no-more">
    <text>没有更多了</text>
  </view>
</view>
