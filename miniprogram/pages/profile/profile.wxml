<!--pages/profile/profile.wxml-->
<view class="container">
  <!-- Sidebar Mask -->
  <view class="sidebar-mask" wx:if="{{isSidebarOpen}}" bindtap="toggleSidebar"></view>

  <!-- Sidebar -->
  <view class="sidebar {{isSidebarOpen ? 'open' : ''}}">
    <view class="sidebar-header">
      <image class="sidebar-avatar" src="{{userInfo.avatarUrl || '../../images/avatar.png'}}" mode="aspectFill" binderror="onAvatarError"></image>
      <text class="sidebar-nickname">{{userInfo.nickName || '微信用户'}}</text>
    </view>
    <view class="sidebar-menu">
        <view class="sidebar-item" bindtap="navigateToEditProfile">
          <text>修改资料</text>
        </view>
        <view class="sidebar-item" bindtap="navigateToMessages">
          <text>消息通知</text>
          <view wx:if="{{unreadCount > 0}}" class="unread-badge">{{unreadCount}}</view>
        </view>
        <view class="sidebar-item" bindtap="navigateToMyLikes">
          <text>我的点赞</text>
        </view>
        <view class="sidebar-item" bindtap="navigateToFavoriteFolders">
          <text>我的收藏夹</text>
        </view>
      </view>
  </view>

  <!-- Main Content -->
  <view class="main-content">
    <!-- 加载中骨架屏 -->
    <view wx:if="{{isLoading && myPosts.length === 0}}" class="loading-container">
      <view class="loading-text">加载中...</view>
    </view>

    <!-- 主内容始终渲染 -->
    <view wx:else>
      <!-- User Profile Card -->
      <view class="profile-card profile-card-center">
        <image src="../../images/icons/menu-icon.svg" class="menu-btn-large" bindtap="toggleSidebar" style="z-index:101;"></image>
        <view class="profile-avatar-large">
          <image src="{{userInfo.avatarUrl || '../../images/avatar.png'}}" mode="aspectFill" binderror="onAvatarError"></image>
        </view>
        <view class="profile-info-center">
          <text class="profile-name-center">{{userInfo.nickName || '微信用户'}}</text>
          <text class="profile-bio-center">{{userInfo.bio || '这个用户很懒,什么都还没留下...'}}</text>
        </view>
      </view>
      <!-- 年龄和生日卡片 -->
      <view class="profile-detail-card">
        <text class="detail-item-inline">生日:{{userInfo.birthday ? userInfo.birthday : '未设置'}}</text>
        <text class="detail-item-inline">年龄:{{userInfo.age ? userInfo.age + '岁' : '未知'}}</text>
      </view>
      <!-- Tab Navigation -->
      <view class="tab-navigation">
        <view class="tab-item {{currentTab === 'posts' ? 'active' : ''}}" 
              data-tab="posts" 
              bindtap="switchTab">
          <text>我发布的帖子</text>
        </view>
        <view class="tab-item {{currentTab === 'favorites' ? 'active' : ''}}" 
              data-tab="favorites" 
              bindtap="switchTab">
          <text>收藏</text>
        </view>
      </view>

      <!-- My Posts Section -->
      <view class="my-posts-section" wx:if="{{currentTab === 'posts'}}">
        <block wx:if="{{myPosts.length > 0}}">
          <view wx:for="{{myPosts}}" wx:key="_id" class="post-card" bind:tap="navigateToPostDetail" data-id="{{item._id}}" hover-class="post-item-active">
            <!-- 作者信息 -->
            <view class="author-info">
              <image wx:if="{{item.authorAvatar}}" class="author-avatar" src="{{item.authorAvatar}}" mode="aspectFill" />
              <text class="author-name">{{item.authorName}}</text>
            </view>
            <view class="post-header">
              <text class="post-title">{{item.title}}</text>
            </view>
            <!-- 图片显示逻辑 -->
            <view class="image-container">
              <!-- 多图滑动 -->
              <block wx:if="{{item.imageUrls && item.imageUrls.length > 1}}">
                <swiper id="profile-swiper-{{index}}" class="image-swiper" indicator-dots="true" circular="false" autoplay="false" style="width: 100%; height: {{swiperHeights[index] ? swiperHeights[index] + 'px' : '220px'}};">
                  <block wx:for="{{item.imageUrls}}" wx:for-item="imageUrl" wx:key="*this" wx:for-index="imgindex">
                    <swiper-item>
                      <image
                        id="profile-swiper-img-{{index}}-{{imgindex}}"
                        class="post-image"
                        src="{{imageUrl}}"
                        mode="aspectFill"
                        catch:tap="handlePreview"
                        data-src="{{imageUrl}}"
                        data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                        binderror="onImageError"
                        bindload="onImageLoad"
                        data-postindex="{{index}}"
                        data-imgindex="{{imgindex}}"
                        data-type="multi"
                        lazy-load="{{true}}"
                        style="width: 100%; height: 100%; object-fit: cover; background-color: #f0f0f0;"
                      ></image>
                    </swiper-item>
                  </block>
                </swiper>
              </block>
              <!-- 单图 -->
              <block wx:elif="{{item.imageUrls && item.imageUrls.length === 1}}">
                <image
                  id="profile-single-img-{{index}}"
                  class="post-image"
                  src="{{item.imageUrls[0]}}"
                  mode="{{imageClampHeights[index] ? 'aspectFill' : 'widthFix'}}"
                  catch:tap="handlePreview"
                  data-src="{{item.imageUrls[0]}}"
                  data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                  binderror="onImageError"
                  bindload="onImageLoad"
                  data-postindex="{{index}}"
                  data-imgindex="0"
                  data-type="single"
                  lazy-load="{{true}}"
                  style="width: 100%; height: {{imageClampHeights[index] ? imageClampHeights[index] + 'px' : 'auto'}}; object-fit: {{imageClampHeights[index] ? 'cover' : 'contain'}}; background-color: #f0f0f0;"
                ></image>
              </block>
            </view>
            <view class="post-content" wx:if="{{item.content}}">{{item.content}}</view>
            <!-- 每个帖子自己的操作按钮 -->
            <view class="post-actions" catch:tap="stopPropagation">
              <view class="action-left">
                <view class="action-item">
                  <text class="action-text">👍 {{item.votes || 0}}</text>
                </view>
                <view class="action-item">
                  <text class="action-text">💬 {{item.commentCount || 0}}</text>
                </view>
              </view>
              <view class="action-right">
                <button class="delete-btn" size="mini" catch:tap="onDelete" data-postid="{{item._id}}" data-index="{{index}}">删除</button>
              </view>
            </view>
          </view>
          <!-- 加载更多提示 -->
          <view wx:if="{{isLoading && myPosts.length > 0}}" class="loading-container">
            <view class="loading-text">加载中...</view>
          </view>
          <!-- 占位空白，便于触发 onReachBottom -->
          <view style="height: 200rpx;"></view>
        </block>
        <view wx:else class="empty-tip">
          <text>你还没有发布过帖子哦～</text>
        </view>
      </view>

      <!-- Favorites Section -->
      <view class="favorites-section" wx:if="{{currentTab === 'favorites'}}">
        <block wx:if="{{favoriteList.length > 0}}">
          <view wx:for="{{favoriteList}}" wx:key="_id" class="post-card" bind:tap="navigateToFavoriteDetail" data-id="{{item._id}}" hover-class="post-item-active">
            <!-- 作者信息 -->
            <view class="author-info">
              <image wx:if="{{item.authorAvatar}}" class="author-avatar" src="{{item.authorAvatar}}" mode="aspectFill" />
              <text class="author-name">{{item.authorName}}</text>
            </view>
            <view class="post-header">
              <text class="post-title">{{item.title}}</text>
            </view>
            <!-- 图片显示逻辑 -->
            <view class="image-container">
              <!-- 多图滑动 -->
              <block wx:if="{{item.imageUrls && item.imageUrls.length > 1}}">
                <swiper id="favorite-swiper-{{index}}" class="image-swiper" indicator-dots="true" circular="false" autoplay="false" style="width: 100%; height: {{swiperHeights[index] ? swiperHeights[index] + 'px' : '220px'}};">
                  <block wx:for="{{item.imageUrls}}" wx:for-item="imageUrl" wx:key="*this" wx:for-index="imgindex">
                    <swiper-item>
                      <image
                        id="favorite-swiper-img-{{index}}-{{imgindex}}"
                        class="post-image"
                        src="{{imageUrl}}"
                        mode="aspectFill"
                        catch:tap="handlePreview"
                        data-src="{{imageUrl}}"
                        data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                        binderror="onImageError"
                        bindload="onImageLoad"
                        data-postindex="{{index}}"
                        data-imgindex="{{imgindex}}"
                        data-type="multi"
                        lazy-load="{{true}}"
                        style="width: 100%; height: 100%; object-fit: cover; background-color: #f0f0f0;"
                      ></image>
                    </swiper-item>
                  </block>
                </swiper>
              </block>
              <!-- 单图 -->
              <block wx:elif="{{item.imageUrls && item.imageUrls.length === 1}}">
                <image
                  id="favorite-single-img-{{index}}"
                  class="post-image"
                  src="{{item.imageUrls[0]}}"
                  mode="{{imageClampHeights[index] ? 'aspectFill' : 'widthFix'}}"
                  catch:tap="handlePreview"
                  data-src="{{item.imageUrls[0]}}"
                  data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                  binderror="onImageError"
                  bindload="onImageLoad"
                  data-postindex="{{index}}"
                  data-imgindex="0"
                  data-type="single"
                  lazy-load="{{true}}"
                  style="width: 100%; height: {{imageClampHeights[index] ? imageClampHeights[index] + 'px' : 'auto'}}; object-fit: {{imageClampHeights[index] ? 'cover' : 'contain'}}; background-color: #f0f0f0;"
                ></image>
              </block>
            </view>
            <view class="post-content" wx:if="{{item.content}}">{{item.content}}</view>
            <!-- 收藏时间和操作按钮 -->
            <view class="post-actions" catch:tap="stopPropagation">
              <view class="action-left">
                <view class="action-item">
                  <text class="action-text">收藏于 {{item.formattedFavoriteTime || '未知时间'}}</text>
                </view>
              </view>
              <view class="action-right">
                <button class="remove-favorite-btn" size="mini" catch:tap="removeFavorite" data-favorite-id="{{item.favoriteId}}" data-index="{{index}}">取消收藏</button>
              </view>
            </view>
          </view>
          <!-- 加载更多提示 -->
          <view wx:if="{{favoriteLoading && favoriteList.length > 0}}" class="loading-container">
            <view class="loading-text">加载中...</view>
          </view>
          <!-- 占位空白，便于触发 onReachBottom -->
          <view style="height: 200rpx;"></view>
        </block>
        <view wx:else class="empty-tip">
          <text>你还没有收藏过内容哦～</text>
        </view>
      </view>
    </view>
  </view>
</view>