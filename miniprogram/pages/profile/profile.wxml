<!--pages/profile/profile.wxml-->
<view class="container">
  <!-- Sidebar Mask -->
  <view class="sidebar-mask" wx:if="{{isSidebarOpen}}" bindtap="toggleSidebar"></view>

  <!-- Sidebar -->
  <view class="sidebar {{isSidebarOpen ? 'open' : ''}}">
    <view class="sidebar-header">
      <image class="sidebar-avatar" src="{{userInfo.avatarUrl || '../../images/avatar.png'}}" mode="aspectFill" binderror="onAvatarError"></image>
      <text class="sidebar-nickname">{{userInfo.nickName || 'å¾®ä¿¡ç”¨æˆ·'}}</text>
    </view>
    <view class="sidebar-menu">
        <view class="sidebar-item" bindtap="navigateToEditProfile">
          <text>ä¿®æ”¹èµ„æ–™</text>
        </view>
        <view class="sidebar-item" bindtap="navigateToMessages">
          <text>æ¶ˆæ¯é€šçŸ¥</text>
          <view wx:if="{{unreadCount > 0}}" class="unread-badge">{{unreadCount}}</view>
        </view>
        <view class="sidebar-item" bindtap="navigateToMyLikes">
          <text>æˆ‘çš„ç‚¹èµ</text>
        </view>
        <view class="sidebar-item" bindtap="navigateToFavoriteFolders">
          <text>æˆ‘çš„æ”¶è—å¤¹</text>
        </view>
      </view>
  </view>

  <!-- Main Content -->
  <view class="main-content">
    <!-- åŠ è½½ä¸­éª¨æ¶å± -->
    <view wx:if="{{isLoading && myPosts.length === 0}}" class="loading-container">
      <view class="loading-text">åŠ è½½ä¸­...</view>
    </view>

    <!-- ä¸»å†…å®¹å§‹ç»ˆæ¸²æŸ“ -->
    <view wx:else>
      <!-- User Profile Card -->
      <view class="profile-card profile-card-center">
        <image src="../../images/icons/menu-icon.svg" class="menu-btn-large" bindtap="toggleSidebar" style="z-index:101;"></image>
        <view class="profile-avatar-large">
          <image src="{{userInfo.avatarUrl || '../../images/avatar.png'}}" mode="aspectFill" binderror="onAvatarError"></image>
        </view>
        <view class="profile-info-center">
          <text class="profile-name-center">{{userInfo.nickName || 'å¾®ä¿¡ç”¨æˆ·'}}</text>
          <text class="profile-bio-center">{{userInfo.bio || 'è¿™ä¸ªç”¨æˆ·å¾ˆæ‡’,ä»€ä¹ˆéƒ½è¿˜æ²¡ç•™ä¸‹...'}}</text>
        </view>
      </view>
      <!-- å¹´é¾„å’Œç”Ÿæ—¥å¡ç‰‡ -->
      <view class="profile-detail-card">
        <text class="detail-item-inline">ç”Ÿæ—¥:{{userInfo.birthday ? userInfo.birthday : 'æœªè®¾ç½®'}}</text>
        <text class="detail-item-inline">å¹´é¾„:{{userInfo.age ? userInfo.age + 'å²' : 'æœªçŸ¥'}}</text>
      </view>
      <!-- Tab Navigation -->
      <view class="tab-navigation">
        <view class="tab-item {{currentTab === 'posts' ? 'active' : ''}}" 
              data-tab="posts" 
              bindtap="switchTab">
          <text>æˆ‘å‘å¸ƒçš„å¸–å­</text>
        </view>
        <view class="tab-item {{currentTab === 'favorites' ? 'active' : ''}}" 
              data-tab="favorites" 
              bindtap="switchTab">
          <text>æ”¶è—</text>
        </view>
      </view>

      <!-- My Posts Section -->
      <view class="my-posts-section" wx:if="{{currentTab === 'posts'}}">
        <block wx:if="{{myPosts.length > 0}}">
          <view wx:for="{{myPosts}}" wx:key="_id" class="post-card" bind:tap="navigateToPostDetail" data-id="{{item._id}}" hover-class="post-item-active">
            <!-- ä½œè€…ä¿¡æ¯ -->
            <view class="author-info">
              <image wx:if="{{item.authorAvatar}}" class="author-avatar" src="{{item.authorAvatar}}" mode="aspectFill" />
              <text class="author-name">{{item.authorName}}</text>
            </view>
            <view class="post-header">
              <text class="post-title">{{item.title}}</text>
            </view>
            <!-- å›¾ç‰‡æ˜¾ç¤ºé€»è¾‘ -->
            <view class="image-container">
              <!-- å¤šå›¾æ»‘åŠ¨ -->
              <block wx:if="{{item.imageUrls && item.imageUrls.length > 1}}">
                <swiper id="profile-swiper-{{index}}" class="image-swiper" indicator-dots="true" circular="false" autoplay="false" style="width: 100%; height: {{swiperHeights[index] ? swiperHeights[index] + 'px' : '220px'}};">
                  <block wx:for="{{item.imageUrls}}" wx:for-item="imageUrl" wx:key="*this" wx:for-index="imgindex">
                    <swiper-item>
                      <image
                        id="profile-swiper-img-{{index}}-{{imgindex}}"
                        class="post-image"
                        src="{{imageUrl}}"
                        mode="aspectFill"
                        catch:tap="handlePreview"
                        data-src="{{imageUrl}}"
                        data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                        binderror="onImageError"
                        bindload="onImageLoad"
                        data-postindex="{{index}}"
                        data-imgindex="{{imgindex}}"
                        data-type="multi"
                        lazy-load="{{true}}"
                        style="width: 100%; height: 100%; object-fit: cover; background-color: #f0f0f0;"
                      ></image>
                    </swiper-item>
                  </block>
                </swiper>
              </block>
              <!-- å•å›¾ -->
              <block wx:elif="{{item.imageUrls && item.imageUrls.length === 1}}">
                <image
                  id="profile-single-img-{{index}}"
                  class="post-image"
                  src="{{item.imageUrls[0]}}"
                  mode="{{imageClampHeights[index] ? 'aspectFill' : 'widthFix'}}"
                  catch:tap="handlePreview"
                  data-src="{{item.imageUrls[0]}}"
                  data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                  binderror="onImageError"
                  bindload="onImageLoad"
                  data-postindex="{{index}}"
                  data-imgindex="0"
                  data-type="single"
                  lazy-load="{{true}}"
                  style="width: 100%; height: {{imageClampHeights[index] ? imageClampHeights[index] + 'px' : 'auto'}}; object-fit: {{imageClampHeights[index] ? 'cover' : 'contain'}}; background-color: #f0f0f0;"
                ></image>
              </block>
            </view>
            <view class="post-content" wx:if="{{item.content}}">{{item.content}}</view>
            <!-- æ¯ä¸ªå¸–å­è‡ªå·±çš„æ“ä½œæŒ‰é’® -->
            <view class="post-actions" catch:tap="stopPropagation">
              <view class="action-left">
                <view class="action-item">
                  <text class="action-text">ğŸ‘ {{item.votes || 0}}</text>
                </view>
                <view class="action-item">
                  <text class="action-text">ğŸ’¬ {{item.commentCount || 0}}</text>
                </view>
              </view>
              <view class="action-right">
                <button class="delete-btn" size="mini" catch:tap="onDelete" data-postid="{{item._id}}" data-index="{{index}}">åˆ é™¤</button>
              </view>
            </view>
          </view>
          <!-- åŠ è½½æ›´å¤šæç¤º -->
          <view wx:if="{{isLoading && myPosts.length > 0}}" class="loading-container">
            <view class="loading-text">åŠ è½½ä¸­...</view>
          </view>
          <!-- å ä½ç©ºç™½ï¼Œä¾¿äºè§¦å‘ onReachBottom -->
          <view style="height: 200rpx;"></view>
        </block>
        <view wx:else class="empty-tip">
          <text>ä½ è¿˜æ²¡æœ‰å‘å¸ƒè¿‡å¸–å­å“¦ï½</text>
        </view>
      </view>

      <!-- Favorites Section -->
      <view class="favorites-section" wx:if="{{currentTab === 'favorites'}}">
        <block wx:if="{{favoriteList.length > 0}}">
          <view wx:for="{{favoriteList}}" wx:key="_id" class="post-card" bind:tap="navigateToFavoriteDetail" data-id="{{item._id}}" hover-class="post-item-active">
            <!-- ä½œè€…ä¿¡æ¯ -->
            <view class="author-info">
              <image wx:if="{{item.authorAvatar}}" class="author-avatar" src="{{item.authorAvatar}}" mode="aspectFill" />
              <text class="author-name">{{item.authorName}}</text>
            </view>
            <view class="post-header">
              <text class="post-title">{{item.title}}</text>
            </view>
            <!-- å›¾ç‰‡æ˜¾ç¤ºé€»è¾‘ -->
            <view class="image-container">
              <!-- å¤šå›¾æ»‘åŠ¨ -->
              <block wx:if="{{item.imageUrls && item.imageUrls.length > 1}}">
                <swiper id="favorite-swiper-{{index}}" class="image-swiper" indicator-dots="true" circular="false" autoplay="false" style="width: 100%; height: {{swiperHeights[index] ? swiperHeights[index] + 'px' : '220px'}};">
                  <block wx:for="{{item.imageUrls}}" wx:for-item="imageUrl" wx:key="*this" wx:for-index="imgindex">
                    <swiper-item>
                      <image
                        id="favorite-swiper-img-{{index}}-{{imgindex}}"
                        class="post-image"
                        src="{{imageUrl}}"
                        mode="aspectFill"
                        catch:tap="handlePreview"
                        data-src="{{imageUrl}}"
                        data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                        binderror="onImageError"
                        bindload="onImageLoad"
                        data-postindex="{{index}}"
                        data-imgindex="{{imgindex}}"
                        data-type="multi"
                        lazy-load="{{true}}"
                        style="width: 100%; height: 100%; object-fit: cover; background-color: #f0f0f0;"
                      ></image>
                    </swiper-item>
                  </block>
                </swiper>
              </block>
              <!-- å•å›¾ -->
              <block wx:elif="{{item.imageUrls && item.imageUrls.length === 1}}">
                <image
                  id="favorite-single-img-{{index}}"
                  class="post-image"
                  src="{{item.imageUrls[0]}}"
                  mode="{{imageClampHeights[index] ? 'aspectFill' : 'widthFix'}}"
                  catch:tap="handlePreview"
                  data-src="{{item.imageUrls[0]}}"
                  data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                  binderror="onImageError"
                  bindload="onImageLoad"
                  data-postindex="{{index}}"
                  data-imgindex="0"
                  data-type="single"
                  lazy-load="{{true}}"
                  style="width: 100%; height: {{imageClampHeights[index] ? imageClampHeights[index] + 'px' : 'auto'}}; object-fit: {{imageClampHeights[index] ? 'cover' : 'contain'}}; background-color: #f0f0f0;"
                ></image>
              </block>
            </view>
            <view class="post-content" wx:if="{{item.content}}">{{item.content}}</view>
            <!-- æ”¶è—æ—¶é—´å’Œæ“ä½œæŒ‰é’® -->
            <view class="post-actions" catch:tap="stopPropagation">
              <view class="action-left">
                <view class="action-item">
                  <text class="action-text">æ”¶è—äº {{item.formattedFavoriteTime || 'æœªçŸ¥æ—¶é—´'}}</text>
                </view>
              </view>
              <view class="action-right">
                <button class="remove-favorite-btn" size="mini" catch:tap="removeFavorite" data-favorite-id="{{item.favoriteId}}" data-index="{{index}}">å–æ¶ˆæ”¶è—</button>
              </view>
            </view>
          </view>
          <!-- åŠ è½½æ›´å¤šæç¤º -->
          <view wx:if="{{favoriteLoading && favoriteList.length > 0}}" class="loading-container">
            <view class="loading-text">åŠ è½½ä¸­...</view>
          </view>
          <!-- å ä½ç©ºç™½ï¼Œä¾¿äºè§¦å‘ onReachBottom -->
          <view style="height: 200rpx;"></view>
        </block>
        <view wx:else class="empty-tip">
          <text>ä½ è¿˜æ²¡æœ‰æ”¶è—è¿‡å†…å®¹å“¦ï½</text>
        </view>
      </view>
    </view>
  </view>
</view>