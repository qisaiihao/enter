<!--pages/profile/profile.wxml-->
<view class="container">
  <!-- 骨架屏：当 isLoading 为 true 时，显示骨架屏，其他所有内容都不渲染 -->
  <view wx:if="{{isLoading}}">
    <skeleton />
  </view>

  <!-- 真实内容：当 isLoading 为 false 时，显示真实页面 -->
  <scroll-view 
    wx:else
    class="scroll-container"
    scroll-y="{{true}}"
    bindscrolltolower="onScrollToLower"
    lower-threshold="100"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
  >
    <!-- Sidebar Mask -->
    <view class="sidebar-mask" wx:if="{{isSidebarOpen}}" bindtap="toggleSidebar"></view>

    <!-- Sidebar -->
    <view class="sidebar {{isSidebarOpen ? 'open' : ''}}">
      <view class="sidebar-header">
        <image class="sidebar-avatar" src="{{userInfo.avatarUrl || '../../images/avatar.png'}}" mode="aspectFill" binderror="onAvatarError"></image>
        <text class="sidebar-nickname">{{userInfo.nickName || '微信用户'}}</text>
      </view>
      <view class="sidebar-menu">
        <view class="sidebar-item" bindtap="navigateToEditProfile">
          <text>修改资料</text>
        </view>
        <view class="sidebar-item" wx:if="{{isAdmin}}" bindtap="navigateToImageManager">
          <text>图片管理</text>
        </view>
        <view class="sidebar-item" bindtap="navigateToMessages">
          <text>消息通知</text>
          <view wx:if="{{unreadCount > 0}}" class="unread-badge">{{unreadCount}}</view>
        </view>
        <view class="sidebar-item" bindtap="navigateToMyLikes">
          <text>我的点赞</text>
        </view>
        <view class="sidebar-item" bindtap="navigateToFavoriteFolders">
          <text>我的收藏夹</text>
        </view>
      </view>
    </view>

    <!-- Main Content -->
    <view class="main-content">
      <!-- User Profile Card -->
      <view class="profile-card profile-card-center">
        <!-- 菜单按钮 -->
        <image src="../../images/icons/menu-icon.svg" class="menu-btn-large" bindtap="toggleSidebar" style="z-index:101;"></image>
        <view class="profile-avatar-large">
          <image src="{{userInfo.avatarUrl || '../../images/avatar.png'}}" mode="aspectFill" binderror="onAvatarError"></image>
        </view>
        <view class="profile-info-center">
          <text class="profile-name-center">{{userInfo.nickName || '微信用户'}}</text>
          <text class="profile-bio-center">{{userInfo.bio || '这个用户很懒,什么都还没留下...'}}</text>
        </view>
      </view>
      <!-- 年龄和生日卡片 -->
      <view wx:if="{{isViewingSelf}}" class="profile-detail-card">
        <text class="detail-item-inline">生日:{{userInfo.birthday ? userInfo.birthday : '未设置'}}</text>
        <text class="detail-item-inline">年龄:{{userInfo.age ? userInfo.age + '岁' : '未知'}}</text>
      </view>
      <!-- Tab Navigation -->
      <view class="tab-navigation">
        <view class="tab-item {{currentTab === 'posts' ? 'active' : ''}}" data-tab="posts" bindtap="switchTab">
          <text>我发布的帖子</text>
        </view>
        <view class="tab-item {{currentTab === 'favorites' ? 'active' : ''}}" data-tab="favorites" bindtap="switchTab">
          <text>收藏</text>
        </view>
      </view>

      <!-- My Posts Section -->
      <view class="my-posts-section" wx:if="{{currentTab === 'posts'}}">
        <block wx:if="{{myPosts.length > 0}}">
          <!-- ... 你的帖子循环代码保持不变 ... -->
          <view 
            wx:for="{{myPosts}}" 
            wx:key="_id" 
            wx:for-index="index"
            class="post-item-wrapper {{item.isOriginal ? 'original-post' : ''}}"
          >
            <!-- 作者信息 -->
            <view class="author-info-outside">
              <image wx:if="{{item.authorAvatar}}" class="author-avatar" src="{{item.authorAvatar}}" mode="aspectFill" binderror="onAvatarError" bindload="onAvatarLoad" data-postindex="{{index}}" catch:tap="navigateToUserProfile" data-user-id="{{item._openid}}"></image>
              <text class="author-name">{{item.authorName}}</text>
            </view>
            
            <!-- 可点击的内容区域 - 跳转到详情页 -->
            <navigator 
              class="post-content-navigator"
              url="/pages/post-detail/post-detail?id={{item._id}}"
              hover-class="navigator-hover"
            >
              <view class="post-item">
                <view class="post-title">{{item.title}}</view>
                <!-- 诗歌作者信息 -->
                <view wx:if="{{item.isPoem && item.author}}" class="poem-author">{{item.author}}</view>
                
                <!-- 图片显示逻辑 (已优化，使用 imageStyle 占位) -->
                <view wx:if="{{(item.imageUrls && item.imageUrls.length > 0)}}" 
                      class="image-container-wrapper" 
                      style="{{item.imageStyle}}" 
                      catch:tap="handlePreview" 
                      data-src="{{item.imageUrls[0]}}"
                      data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}">

                  <!-- 单张图片 -->
                  <block wx:if="{{item.imageUrls.length === 1}}">
                    <image
                      id="single-image-{{item._id}}"
                      class="post-image"
                      src="{{item.imageUrls[0]}}"
                      mode="aspectFill"
                      lazy-load="{{true}}"
                      binderror="onImageError"
                      bindload="onImageLoad"
                      data-postid="{{item._id}}"
                      data-postindex="{{index}}"
                      data-imgindex="0"
                      data-type="single"
                    />
                  </block>

                  <!-- 多张图片 -->
                  <block wx:elif="{{item.imageUrls.length > 1}}">
                    <swiper id="swiper-{{item._id}}" class="image-swiper" indicator-dots="true" circular="true" style="height: {{swiperHeights[index] ? swiperHeights[index] + 'px' : '220px'}};">
                      <block wx:for="{{item.imageUrls}}" wx:for-item="img" wx:key="*this" wx:for-index="imgindex">
                        <swiper-item>
                          <image
                            class="post-image"
                            src="{{img}}"
                            mode="aspectFill"
                            lazy-load="{{true}}"
                            binderror="onImageError"
                            bindload="onImageLoad"
                            catch:tap="handlePreview"
                            data-src="{{img}}"
                            data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                            data-postid="{{item._id}}"
                            data-postindex="{{index}}"
                            data-imgindex="{{imgindex}}"
                            data-type="multi"
                          />
                        </swiper-item>
                      </block>
                    </swiper>
                  </block>
                </view>
                  
                <view class="post-content" wx:if="{{item.content}}" style="white-space: pre-wrap;">{{item.content}}</view>
                
                <!-- 标签显示 -->
                <view wx:if="{{item.tags && item.tags.length > 0}}" class="post-tags">
                  <text wx:for="{{item.tags}}" wx:key="index" 
                        class="post-tag" 
                        catchtap="onTagClick" 
                        data-tag="{{item}}">#{{item}}</text>
                </view>
              </view>
            </navigator>

            <!-- 删除按钮区域 -->
            <view class="delete-section">
              <view class="time-left">
                <text class="post-time">发布于 {{item.formattedCreateTime || '未知时间'}}</text>
              </view>
              <view class="button-group">
                <button class="delete-btn" size="mini" catch:tap="onDelete" data-postid="{{item._id}}" data-index="{{index}}">删除</button>
              </view>
            </view>
          </view>
          <!-- 加载更多提示 -->
          <view class="loading-footer">
            <block wx:if="{{isLoadingMore}}">
              <text>正在加载...</text>
            </block>
            <block wx:elif="{{!hasMore && myPosts.length > 0}}">
              <text>--- 我是有底线的 ---</text>
            </block>
          </view>
          <view style="height: 200rpx;"></view>
        </block>
        <view wx:else class="empty-tip">
          <text>你还没有发布过帖子哦～</text>
        </view>
      </view>

      <!-- Favorites Section -->
      <view class="favorites-section" wx:if="{{currentTab === 'favorites'}}">
        <block wx:if="{{favoriteList.length > 0}}">
          <view 
            wx:for="{{favoriteList}}" 
            wx:key="_id" 
            wx:for-index="index"
            class="post-item-wrapper {{item.isOriginal ? 'original-post' : ''}}"
          >
            <!-- 作者信息 -->
            <view class="author-info-outside">
              <image wx:if="{{item.authorAvatar}}" class="author-avatar" src="{{item.authorAvatar}}" mode="aspectFill" binderror="onAvatarError" bindload="onAvatarLoad" data-postindex="{{index}}" catch:tap="navigateToUserProfile" data-user-id="{{item._openid}}"></image>
              <text class="author-name">{{item.authorName}}</text>
            </view>
            
            <!-- 可点击的内容区域 - 跳转到详情页 -->
            <navigator 
              class="post-content-navigator"
              url="/pages/post-detail/post-detail?id={{item._id}}"
              hover-class="navigator-hover"
            >
              <view class="post-item">
                <view class="post-title">{{item.title}}</view>
                <!-- 诗歌作者信息 -->
                <view wx:if="{{item.isPoem && item.author}}" class="poem-author">{{item.author}}</view>
                
                <!-- 图片显示逻辑 (已优化，使用 imageStyle 占位) -->
                <view wx:if="{{(item.imageUrls && item.imageUrls.length > 0)}}" 
                      class="image-container-wrapper" 
                      style="{{item.imageStyle}}" 
                      catch:tap="handlePreview" 
                      data-src="{{item.imageUrls[0]}}"
                      data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}">

                  <!-- 单张图片 -->
                  <block wx:if="{{item.imageUrls.length === 1}}">
                    <image
                      id="single-image-{{item._id}}"
                      class="post-image"
                      src="{{item.imageUrls[0]}}"
                      mode="aspectFill"
                      lazy-load="{{true}}"
                      binderror="onImageError"
                      bindload="onImageLoad"
                      data-postid="{{item._id}}"
                      data-postindex="{{index}}"
                      data-imgindex="0"
                      data-type="single"
                    />
                  </block>

                  <!-- 多张图片 -->
                  <block wx:elif="{{item.imageUrls.length > 1}}">
                    <swiper id="swiper-{{item._id}}" class="image-swiper" indicator-dots="true" circular="true" style="height: {{swiperHeights[index] ? swiperHeights[index] + 'px' : '220px'}};">
                      <block wx:for="{{item.imageUrls}}" wx:for-item="img" wx:key="*this" wx:for-index="imgindex">
                        <swiper-item>
                          <image
                            class="post-image"
                            src="{{img}}"
                            mode="aspectFill"
                            lazy-load="{{true}}"
                            binderror="onImageError"
                            bindload="onImageLoad"
                            catch:tap="handlePreview"
                            data-src="{{img}}"
                            data-original-image-urls="{{item.originalImageUrls || item.imageUrls}}"
                            data-postid="{{item._id}}"
                            data-postindex="{{index}}"
                            data-imgindex="{{imgindex}}"
                            data-type="multi"
                          />
                        </swiper-item>
                      </block>
                    </swiper>
                  </block>
                </view>
                  
                <view class="post-content" wx:if="{{item.content}}" style="white-space: pre-wrap;">{{item.content}}</view>
                
                <!-- 标签显示 -->
                <view wx:if="{{item.tags && item.tags.length > 0}}" class="post-tags">
                  <text wx:for="{{item.tags}}" wx:key="index" 
                        class="post-tag" 
                        catchtap="onTagClick" 
                        data-tag="{{item}}">#{{item}}</text>
                </view>
              </view>
            </navigator>

            <!-- 取消收藏按钮区域 -->
            <view class="delete-section">
              <view class="time-left">
                <text class="favorite-time">收藏于 {{item.formattedFavoriteTime || '未知时间'}}</text>
              </view>
              <view class="button-group">
                <button class="remove-favorite-btn" size="mini" catch:tap="removeFavorite" data-favorite-id="{{item.favoriteId}}" data-index="{{index}}">取消收藏</button>
              </view>
            </view>
          </view>
          <!-- 加载更多提示 -->
          <view class="loading-footer">
            <block wx:if="{{favoriteLoading}}">
              <text>正在加载...</text>
            </block>
            <block wx:elif="{{!favoriteHasMore && favoriteList.length > 0}}">
              <text>--- 我是有底线的 ---</text>
            </block>
          </view>
          <view style="height: 200rpx;"></view>
        </block>
        <view wx:else class="empty-tip">
          <text>你还没有收藏过内容哦～</text>
        </view>
      </view>
    </view>
  </scroll-view>
</view> <!-- 这是为 <view class="container"> 添加的结束标签 -->

<!-- 自定义tabBar -->
<custom-tabbar />