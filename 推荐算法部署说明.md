# 推荐算法部署说明

## 新增云函数

本次更新新增了4个云函数，需要上传到云端：

### 1. getPersonalizedFeed - 个性化推荐
- **功能**：基于用户互动记录推荐相似内容
- **路径**：`cloudfunctions/getPersonalizedFeed/`
- **依赖**：需要 `votes_log` 和 `view_log` 集合

### 2. getHotFeed - 热门推荐  
- **功能**：基于热度分推荐热门内容
- **路径**：`cloudfunctions/getHotFeed/`
- **依赖**：需要 `posts` 集合有 `votes` 和 `commentCount` 字段

### 3. getRecommendationFeed - 混合推荐
- **功能**：按3:2比例混合个性化和热门推荐
- **路径**：`cloudfunctions/getRecommendationFeed/`
- **依赖**：调用上述两个云函数

### 4. recordView - 浏览记录
- **功能**：记录用户浏览行为
- **路径**：`cloudfunctions/recordView/`
- **依赖**：需要 `view_log` 集合

## 数据库集合

### 新增集合：view_log
用于记录用户浏览行为，结构如下：
```json
{
  "_id": "记录ID",
  "_openid": "用户OpenID", 
  "postId": "帖子ID",
  "viewDuration": 30, // 浏览时长（秒）
  "createTime": "创建时间",
  "lastViewTime": "最后浏览时间",
  "type": "view" // 记录类型
}
```

## 部署步骤

1. **上传云函数**
   ```bash
   # 在项目根目录执行
   ./uploadCloudFunction.sh getPersonalizedFeed
   ./uploadCloudFunction.sh getHotFeed  
   ./uploadCloudFunction.sh getRecommendationFeed
   ./uploadCloudFunction.sh recordView
   ```

2. **创建数据库集合**
   - 在云开发控制台创建 `view_log` 集合
   - 设置集合权限为"仅创建者可读写"

3. **测试功能**
   - 进入发现页，查看推荐是否正常显示
   - 浏览几个帖子，检查浏览记录是否正常收集
   - 下拉刷新发现页，检查推荐是否重新排序

## 注意事项

- 推荐算法需要用户有一定的互动记录才能工作
- 新用户首次进入发现页可能只显示热门推荐
- 浏览记录只有超过3秒才会被记录
- 推荐结果会随机打乱顺序，避免固定模式

## 性能优化

- 个性化推荐限制获取最近50条互动记录
- 热门推荐使用聚合查询计算热度分
- 图片URL批量转换，减少网络请求
- 防重复机制避免重复推荐相同内容
